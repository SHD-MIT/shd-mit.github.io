<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/2024/assets/css/just-the-docs-default.css"> <script src="/2024/assets/js/vendor/lunr.min.js"></script> <script src="/2024/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>CTF of Physical Attacks | 6.5950/6.5951</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="CTF of Physical Attacks" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Secure Hardware Design" /> <meta property="og:description" content="Secure Hardware Design" /> <meta property="og:site_name" content="6.5950/6.5951" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="CTF of Physical Attacks" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Secure Hardware Design","headline":"CTF of Physical Attacks","url":"/2024/recitations/physical.html"}</script> <!-- End Jekyll SEO tag --> <!-- Cover up the page while CSS is loading to prevent flicker --> <div id="preload-cover"></div> <style> #preload-cover { position:fixed; height:100%; width:100%; top:0; left:0; background:#fff; z-index:9999; } @media (prefers-color-scheme: dark) { #preload-cover { position:fixed; height:100%; width:100%; top:0; left:0; background:#222326; z-index:9999; } } </style> <script> window.addEventListener('load', function() { var cover = document.getElementById('preload-cover'); cover.style.display = 'none'; }); </script> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Feather. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/2024/" class="site-title lh-tight"> 6.5950/6.5951 </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/2024/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/2024/calendar.html" class="nav-list-link">Calendar</a></li><li class="nav-list-item"><a href="/2024/lectureReadings.html" class="nav-list-link">Lecture Readings</a></li><li class="nav-list-item"><a href="/2024/paperDiscussion.html" class="nav-list-link">Paper Discussion</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Recitations category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/2024/recitations.html" class="nav-list-link">Recitations</a><ul class="nav-list "><li class="nav-list-item "><a href="/2024/recitations/cpp.html" class="nav-list-link">CTF of C Programming</a></li><li class="nav-list-item active"><a href="/2024/recitations/physical.html" class="nav-list-link active">CTF of Physical Attacks</a></li><li class="nav-list-item "><a href="/2024/recitations/riscv.html" class="nav-list-link">Binary Exploitation and RISC-V Warmup</a></li><li class="nav-list-item "><a href="/2024/recitations/formal.html" class="nav-list-link">Formal Verification</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Labs category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/2024/labs.html" class="nav-list-link">Labs</a><ul class="nav-list "><li class="nav-list-item "><a href="/2024/labs/fingerprinting.html" class="nav-list-link">Website Fingerprinting</a></li><li class="nav-list-item "><a href="/2024/labs/cache.html" class="nav-list-link">Cache Attacks</a></li><li class="nav-list-item "><a href="/2024/labs/spectre.html" class="nav-list-link">Spectre Attacks</a></li><li class="nav-list-item "><a href="/2024/labs/rowhammer.html" class="nav-list-link">Rowhammer</a></li><li class="nav-list-item "><a href="/2024/labs/aslr.html" class="nav-list-link">ASLR Bypasses</a></li><li class="nav-list-item "><a href="/2024/labs/psp.html" class="nav-list-link">Pretty Secure Processor</a></li><li class="nav-list-item "><a href="/2024/labs/fuzz.html" class="nav-list-link">CPU Fuzzing</a></li><li class="nav-list-item "><a href="/2024/labs/formal.html" class="nav-list-link">CPU Verification</a></li></ul></li><li class="nav-list-item"><a href="/2024/paperReadingGuidance.html" class="nav-list-link">Paper Readings Guidance</a></li><li class="nav-list-item"><a href="/2024/forInstructors.html" class="nav-list-link">For Instructors</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search 6.5950/6.5951" aria-label="Search 6.5950/6.5951" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/2024/recitations.html">Recitations</a></li> <li class="breadcrumb-nav-list-item"><span>CTF of Physical Attacks</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <!-- # Recitation Activities Spring 2022 Notes: Here are some resources for our various recitation activities throughout the semester. ## 1. C CTF Capture the flag competition to solve some challenging C language problems. (TODO: Post setup instructions and solutions). Solutions are on Piazza @16. [Notes](../../slides/rec1.pdf) ## 2. Speculative Execution Lab Running spectre / side channel attacks on a toy CPU, and reverse engineering its microarchitecture to understand how spectre-style bugs can arise. [Notes](../../slides/rec2.pdf) --> <!-- MIT{always_read_the_source}. Curious to see if anybody finds this :) --> <script> function ColorCorrect() { const theme = jtd.getTheme(); if (theme == "dark") { document.getElementById("figure1").src = "figures/physical-1-dark.png"; document.getElementById("figure2").src = "figures/physical-2-dark.png"; } else { document.getElementById("figure1").src = "figures/physical-1-light.png"; document.getElementById("figure2").src = "figures/physical-2-light.png"; } } document.addEventListener('DOMContentLoaded', function () { ColorCorrect(); }, false); </script> <h1 class="no_toc" id="ctf-of-physical-attacks"> <a href="#ctf-of-physical-attacks" class="anchor-heading" aria-labelledby="ctf-of-physical-attacks"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CTF of Physical Attacks </h1> <p>Exploiting an insecure <code class="language-plaintext highlighter-rouge">memcmp</code> implementation on a real microcontroller to leak a secret.</p> <p><img src="https://cdn-shop.adafruit.com/970x728/3591-00.jpg" alt="esp32 picture" width="50%" /></p> <p>Image: Adafruit</p> <h2 class="no_toc text-delta" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents </h2> <ul id="markdown-toc"> <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li> <li><a href="#prizes" id="markdown-toc-prizes">Prizes</a></li> <li><a href="#before-class-software-development-environment-setup" id="markdown-toc-before-class-software-development-environment-setup">Before Class: Software Development Environment Setup</a></li> <li><a href="#in-class-hardware-setup" id="markdown-toc-in-class-hardware-setup">In Class: Hardware Setup</a> <ul> <li><a href="#what-is-uart" id="markdown-toc-what-is-uart">What is UART?</a></li> <li><a href="#test-the-communication-with-esp32" id="markdown-toc-test-the-communication-with-esp32">Test the Communication with ESP32</a></li> <li><a href="#wire-up-the-attack-setup" id="markdown-toc-wire-up-the-attack-setup">Wire Up the Attack Setup</a></li> </ul> </li> <li><a href="#warm-up-program-the-attacker-board" id="markdown-toc-warm-up-program-the-attacker-board">Warm Up: Program the Attacker Board</a></li> <li><a href="#get-to-know-the-victim-the-memcmp-vulnerability" id="markdown-toc-get-to-know-the-victim-the-memcmp-vulnerability">Get to Know the Victim: the <code class="language-plaintext highlighter-rouge">memcmp</code> Vulnerability</a></li> <li><a href="#attack-time" id="markdown-toc-attack-time">Attack Time</a> <ul> <li><a href="#suggested-attack-strategy" id="markdown-toc-suggested-attack-strategy">Suggested Attack Strategy</a></li> <li><a href="#provided-code" id="markdown-toc-provided-code">Provided Code</a></li> <li><a href="#measuring-and-communicating-with-the-victim" id="markdown-toc-measuring-and-communicating-with-the-victim">Measuring and Communicating with the Victim</a></li> <li><a href="#useful-methods" id="markdown-toc-useful-methods">Useful methods</a></li> </ul> </li> </ul> <h2 id="introduction"> <a href="#introduction" class="anchor-heading" aria-labelledby="introduction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction </h2> <p>In this recitation, we will attack an <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/index.html">ESP32 chip</a>. ESP32 is a Wifi and Bluetooth enabled microcontroller unit (or called MCU) built on the Xtensa architecture. We will be using two of them today. One is the victim (a password checker from which we will leak the correct password), and the other is the attacker board (which you fully control). You will be writing an ESP32 program on the attacker board to leak the secret from the victim by exploiting a timing side channel.</p> <p>To participate in the CTF, you will bring:</p> <ul> <li>A USB-A capable laptop setup (that is, bring your USB-C to USB-A converters!)</li> <li>The Arduinio toolchain installed (see <a href="#before-class-software-development-environment-setup">Software Development Environment Setup</a>)</li> </ul> <p>TA will bring:</p> <ul> <li>2x ESP32 boards, one programmed with the victim code, and one for the students to write attacker code on</li> <li>2x USB-A to USB-Micro B cables</li> <li>A bundle of jumpers for students to use as needed</li> </ul> <p><strong>All attacks are fair game</strong></p> <ul> <li>You can do whatever you want to these boards.</li> <li>Please try to leave them at least functional though for next year.</li> <li>Our intended bug is probably the easiest way to exploit them, but feel free to do whatever and explore!</li> </ul> <h2 id="prizes"> <a href="#prizes" class="anchor-heading" aria-labelledby="prizes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prizes </h2> <p>The first 3 teams to finish will get 1 ESP32 board per group member (the same kind we used in class today).</p> <h2 id="before-class-software-development-environment-setup"> <a href="#before-class-software-development-environment-setup" class="anchor-heading" aria-labelledby="before-class-software-development-environment-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Before Class: Software Development Environment Setup </h2> <p>You need to install the appropriate board programmer files to your local PC to program the attacker microcontroller with your attack. We are using <a href="https://www.amazon.com/gp/product/B086MGH7JV/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;th=1">this esp32 board</a>. It is identified in Arduino as an <code class="language-plaintext highlighter-rouge">esp32/Node32s</code>.</p> <p>Follow the installation procedure described <a href="https://docs.espressif.com/projects/arduino-esp32/en/latest/installing.html">here</a>. <!-- We need to make some changes because the esp32 board support package has issues with python 2 being deprecated (as of 3/17/2022). --> A brief summary of what you need to do:</p> <ol> <li>Download the <a href="https://www.arduino.cc/en/software">Arduino IDE 2.0.4</a></li> <li>Open Preferences</li> <li>Add <code class="language-plaintext highlighter-rouge">https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json</code> to Additional Boards Manager URLs</li> <li>Close and reopen the Arduino app</li> <li>Open Boards Manager from Tools &gt; Board &gt; Board Manager…</li> <li>Search <code class="language-plaintext highlighter-rouge">esp32</code></li> <li>Install <code class="language-plaintext highlighter-rouge">esp32 Espressif Systems</code></li> <li>Close and Reopen the Arduino app</li> <li>Make sure Tools &gt; Board is set to <code class="language-plaintext highlighter-rouge">ESP32 Arduino/Node32s</code></li> </ol> <blockquote class="warning-title"> <p>Note</p> <p>For windows users, you need to also install and configure PuTTY and the FTDI Drivers as seen <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/establish-serial-connection.html">here</a>.</p> </blockquote> <!-- 1. Close the Arduino app 1. Go to the [`Arduino15`](https://support.arduino.cc/hc/en-us/articles/4411202655634-Find-Arduino-IDE-files-and-folders) folder for the `esp32` vendor and package. 1. On macOS, `~/Library/Arduino15/packages/esp32/hardware/esp32/` 1. On Linux, `~/.arduino15/packages/esp32/hardware/esp32` 1. On Windows, `C:\Users\{username}\AppData\Local\Arduino15\packages\esp32\hardware\esp32` 1. Windows might actually be OK since it uses a different toolchain 1. Edit `platform.txt:13`, replacing `tools.esptool_py.network_cmd` from `python ...` with `python3 ...` 1. Edit `platform.txt:16`, replacing `tools.gen_esp32part.cmd` from `python ...` with `python3 ...` 1. Change `tools/espota.py:1`, `tools/esptool.py:1`, and `tools/gen_esp32part.py:1` to `#!/usr/bin/env python3` 1. Reopen the Arduino app --> <h2 id="in-class-hardware-setup"> <a href="#in-class-hardware-setup" class="anchor-heading" aria-labelledby="in-class-hardware-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> In Class: Hardware Setup </h2> <p>As a physical attack recitation, you will need to interact with hardware devices <em>physically</em>. Read below to understand how we communicate with the ESP32 chip using UART, and follow the instructions to wire things up.</p> <h3 id="what-is-uart"> <a href="#what-is-uart" class="anchor-heading" aria-labelledby="what-is-uart"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> What is UART? </h3> <p>How does the esp32 board communicate with the external world? Using the serial port. Serial, or <a href="https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter">UART</a>, is an asynchronous protocol commonly used for communicating data between devices. Many consumer devices ship with exposed UART pads that transmit and receive data, which can cause many physical security vulnerabilities.</p> <p>Serial consists of 3 pins: RX, TX, and ground. Ground is the same for both devices (as a general rule of thumb, ground is always common amongst everything in a system). One device’s RX connects to the other’s TX, and vice versa. RX is used for receiving, and TX is used for transmitting. See the figure below.</p> <p>The most important parameter for a serial port is the <strong>baud rate</strong>, i.e., the speed at which serial communication runs. Our boards are configured to use the standard baud rate of <code class="language-plaintext highlighter-rouge">115200</code>.</p> <div style="text-align:center"><img src="figures/physical-2-light.png" width="80%" id="figure2" /></div> <!-- ## Victim Serial Ports The victim contains two serial ports that are identical. It can read/ write on both of them simultaneously. One of them is the USB port, and the other is attached to the RX2 and TX2 pins on the board itself. This means you can send passwords from the attacker board, or your laptop, or both at the same time! --> <!-- ## Board Buttons You will notice two buttons on the board. - As we saw earlier, `EN` will reset the board. - `BOOT` is used during programming. Hold it down while uploading the program for the board to be flashed properly. --> <h3 id="test-the-communication-with-esp32"> <a href="#test-the-communication-with-esp32" class="anchor-heading" aria-labelledby="test-the-communication-with-esp32"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Test the Communication with ESP32 </h3> <p>Let’s first test the victim’s connection with our PC to make sure everything’s working. You can attach an ESP32 to your PC using a USB cable. See detailed information <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/establish-serial-connection.html">here</a>.</p> <p>The first step is to find the port name on your computer.</p> <ol> <li>Open the Arduino app with no boards connected.</li> <li>Go to Tools &gt; Port and look at the available ports. <ul> <li>On macOS / Linux you will see something like <code class="language-plaintext highlighter-rouge">/dev/cu.Bluetooth-Incoming-Port</code> (or maybe nothing).</li> <li>On Windows you will probably see nothing, maybe a few <code class="language-plaintext highlighter-rouge">COMX</code> ports (<code class="language-plaintext highlighter-rouge">X</code> is a number).</li> </ul> </li> <li>Plug in the <strong>victim</strong> board and reload Tools &gt; Port and look for the new port. <ul> <li>On macOS / Linux, it will be a dev file like <code class="language-plaintext highlighter-rouge">/dev/cu.usbserial-0001/</code>.</li> <li>On Windows, it will be something like <code class="language-plaintext highlighter-rouge">COM4</code>.</li> </ul> </li> <li>Make note of the port name so we can connect to it later.</li> </ol> <p>Now you can see what the victim boar is doing!</p> <ul> <li>If you’re on macOS / Linux, we can use the <code class="language-plaintext highlighter-rouge">screen</code> command to talk to the victim. <ul> <li><code class="language-plaintext highlighter-rouge">screen {name from above} 115200</code> will give you a terminal.</li> <li>Press <code class="language-plaintext highlighter-rouge">control + A</code>, then <code class="language-plaintext highlighter-rouge">K</code>, and then <code class="language-plaintext highlighter-rouge">Y</code> when you want to exit.</li> </ul> </li> <li>If you’re on Windows, follow the <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/establish-serial-connection.html">PuTTY instructions</a>.</li> </ul> <p>At first your terminal will be blank. Press the <code class="language-plaintext highlighter-rouge">EN</code> button on the board to reset it. You should now see some terminal output.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                              ____    ____  _____  _________             
                             |_   \  /   _||_   _||  _   _  |            
                   ______      |   \/   |    | |  |_/ | | \_|    ______  
                  |______|     | |\  /| |    | |      | |       |______| 
                              _| |_\/_| |_  _| |_    _| |_               
                             |_____||_____||_____|  |_____|              
                                                                         
  ___                        _  _             _                       ___         _
 / __| ___ __ _  _ _ _ ___  | || |__ _ _ _ __| |_ __ ____ _ _ _ ___  |   \ ___ __(_)__ _ _ _
 \__ \/ -_) _| || | '_/ -_) | __ / _` | '_/ _` \ V  V / _` | '_/ -_) | |) / -_|_-&lt; / _` | ' \
 |___/\___\__|\_,_|_| \___| |_||_\__,_|_| \__,_|\_/\_/\__,_|_| \___| |___/\___/__/_\__, |_||_|
                                                                                   |___/
Ravi's Super-Secure Password Checker(TM)
Enter your Password &gt;
</code></pre></div></div> <p>You can type in guessed passwords, and it will tell you if you are correct or not. You should see the light flash and a result printed to the console. Here’s an example if the correct password is <code class="language-plaintext highlighter-rouge">MIT{this_is_a_secret}</code>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Enter your Password &gt; MIT{incorrect_guess}
Try again.
Enter your Password &gt; MIT{this_is_a_secret}
Correct!
Enter your Password &gt;
</code></pre></div></div> <h3 id="wire-up-the-attack-setup"> <a href="#wire-up-the-attack-setup" class="anchor-heading" aria-labelledby="wire-up-the-attack-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Wire Up the Attack Setup </h3> <p>In our attack, we will use another ESP32 board as the attack board to interact with the victim board and monitor the victim’s timing behaviors. Here’s a diagram of the setup we will build:</p> <p><img src="figures/physical-1-light.png" id="figure1" /></p> <p>We are going to attach the attacker and victim together via their secondary serial ports. Both MCUs can also attach to your laptop via USB, to power them up and to see the results of the attack. We will also attach the LED pin of the victim to the attacker so it can measure when the light turns on (more information later). The precise connnections to make depend on which type of the board you get, as follows. (Two types of board we bring label the pins differently.)</p> <p>If your board has a USB-C port, connect:</p> <ol> <li><code class="language-plaintext highlighter-rouge">Attacker.G17</code> (G17 is TX) to <code class="language-plaintext highlighter-rouge">Victim.G16</code> (G16 is RX).</li> <li><code class="language-plaintext highlighter-rouge">Attacker.G16</code> to <code class="language-plaintext highlighter-rouge">Victim.G17</code>.</li> <li><code class="language-plaintext highlighter-rouge">Attacker.G2</code> to <code class="language-plaintext highlighter-rouge">Victim.G2</code> (G2 is the LED pin).</li> <li><code class="language-plaintext highlighter-rouge">Attacker.GND</code> to <code class="language-plaintext highlighter-rouge">Victim.GND</code>.</li> <li>Attach the attacker’s and victim’s USB ports to your computer.</li> </ol> <p>If your board has a USB-Micro port, connect:</p> <ol> <li><code class="language-plaintext highlighter-rouge">Attacker.TX2</code> to <code class="language-plaintext highlighter-rouge">Victim.RX2</code>.</li> <li><code class="language-plaintext highlighter-rouge">Attacker.RX2</code> to <code class="language-plaintext highlighter-rouge">Victim.TX2</code>.</li> <li><code class="language-plaintext highlighter-rouge">Attacker.D2</code> to <code class="language-plaintext highlighter-rouge">Victim.D2</code> (D2 is the LED pin).</li> <li><code class="language-plaintext highlighter-rouge">Attacker.GND</code> to <code class="language-plaintext highlighter-rouge">Victim.GND</code>.</li> <li>Attach the attacker’s and victim’s USB ports to your computer.</li> </ol> <!-- ### Diagnosing Connection Problems {: .no_toc} This resource can help you if you are having issues with not seeing the board show up as a serial device. You may need to install the FTDI drivers if you're on Windows. [Establishing Serial Connections to ESP32](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/establish-serial-connection.html) Now you should be all set to compile programs and upload them. --> <h2 id="warm-up-program-the-attacker-board"> <a href="#warm-up-program-the-attacker-board" class="anchor-heading" aria-labelledby="warm-up-program-the-attacker-board"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Warm Up: Program the Attacker Board </h2> <p>Now you have some rough ideas about your attack plan, let’s learn how to write and upload programs to the attacker board.</p> <p>Below is an example “Hello World” program for ESP32.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// Runs once</span>
	<span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// Runs forever</span>
	<span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Hello, 6.5950!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">setup</code> method runs once when the board is reset. The <code class="language-plaintext highlighter-rouge">loop</code> method runs forever after <code class="language-plaintext highlighter-rouge">setup</code> completes. We will post the starter code on Piazza before the class. The provided attacker code handles setting up both serial to the computer, serial to the victim, and configuring the GPIO pins.</p> <h3 class="no_toc" id="how-to-upload-programs"> <a href="#how-to-upload-programs" class="anchor-heading" aria-labelledby="how-to-upload-programs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to Upload Programs </h3> <ol> <li>Attach the attacker MCU to your PC using a USB cable (as shown in the hardware setup).</li> <li>Ensure the correct port and board (<code class="language-plaintext highlighter-rouge">Node32s</code>) are selected in Tools &gt; Port and Tools &gt; Board. Do not accidentally reflash the victim board. <ul> <li>Note that port are assigned by order of connection to the laptop, so the port name may change if you unplugged the boards and replugged them in later.</li> <li>To be safe you can make it a rule to always flash while only the attacker board is plugged in.</li> </ul> </li> <li>Press the Upload button (it is a rightward pointing arrow). <img src="figures/physical-3.png" alt="Upload Button" width="60%" /></li> <li>Watch the output window at the bottom. <ul> <li>If there are any errors, let the TA know.</li> <li>You may see the output is stuck doing <code class="language-plaintext highlighter-rouge">Connecting........_____....._____....._____.</code> forever. If you see that, try holding down the <code class="language-plaintext highlighter-rouge">BOOT</code> button and trying again.</li> </ul> </li> </ol> <blockquote class="warning"> <p>Take care to only program the attacker board. The victim board should NOT be reprogrammed ever, otherwise the secret will be lost!</p> </blockquote> <blockquote class="exercise-title"> <p>Warmup Exercise</p> <p>If it is the first time you program embedded systems, try upload the hello-world program to the attacker board and see the output.</p> </blockquote> <p>With all the setup and preparation above, we can now take a close look at our victim program and start the attack!</p> <h2 id="get-to-know-the-victim-the-memcmp-vulnerability"> <a href="#get-to-know-the-victim-the-memcmp-vulnerability" class="anchor-heading" aria-labelledby="get-to-know-the-victim-the-memcmp-vulnerability"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Get to Know the Victim: the <code class="language-plaintext highlighter-rouge">memcmp</code> Vulnerability </h2> <p>The victim board reads user-supplied passwords over serial, and tells you if the password was correct or not. Your job is to determine the correct password!</p> <p>When the Super-Secure Password Checker first prototype was shown to customers, they didn’t like the fact that you cannot tell when passwords are being checked. The vendors added this light to provide feedback to the user that computation is going on internally. Specifically, a light is turned on while the password is being checked, and is turned off after the check finishes. However, this light inadvertently leaks the time the MCU takes to check the password.</p> <p>Internally, the microcontroller is using a vulnerable definition of <code class="language-plaintext highlighter-rouge">memcmp</code> to compare your input against the password. Here is the <code class="language-plaintext highlighter-rouge">memcmp</code> definition and invocation:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * memcmp_unsafe
 * Compares buffers buf1 and buf2.
 * Returns true if they are exactly equal, false otherwise.
 */</span>
<span class="n">bool</span> <span class="nf">memcmp_unsafe</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf1</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">buf2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
 * check_passwords
 * Checks the global user input buffer against the global secret.
 */</span>
<span class="n">bool</span> <span class="nf">check_passwords</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">turn_on_light</span><span class="p">();</span> <span class="c1">// The users complained that there was no feedback, so we added a light</span>
	<span class="n">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="n">memcmp_unsafe</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">userbuf</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">SECRET</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">SECRET</span><span class="p">));</span>
	<span class="n">turn_off_light</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>Notice that <code class="language-plaintext highlighter-rouge">memcmp</code> will quit early when it detects an incorrect character in your input. This means that passwords that contain more correct characters will take slightly <em>longer</em> to check than those with fewer correct characters at the beginning.</p> <h2 id="attack-time"> <a href="#attack-time" class="anchor-heading" aria-labelledby="attack-time"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Attack Time </h2> <h3 id="suggested-attack-strategy"> <a href="#suggested-attack-strategy" class="anchor-heading" aria-labelledby="suggested-attack-strategy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Suggested Attack Strategy </h3> <ol> <li>Start by determining how to time an individual victim <code class="language-plaintext highlighter-rouge">memcmp</code> (How do you know when it starts? How do you know when it ends?) <ul> <li>For simplicity, you can start by only timing guesses issued manually via USB connection to the victim. (AKA type into the victim terminal yourself and have the attacker watch for the light).</li> <li>Then move onto having the attacker itself issue guesses.</li> </ul> </li> <li>Move onto parsing the reply from the victim. (Did it say <code class="language-plaintext highlighter-rouge">Correct!</code> or did it say <code class="language-plaintext highlighter-rouge">Try again.</code> ? Do you care…?)</li> <li>Now combine the two to leak the entire secret…</li> </ol> <h3 id="provided-code"> <a href="#provided-code" class="anchor-heading" aria-labelledby="provided-code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Provided Code </h3> <ul> <li>You will fill in <code class="language-plaintext highlighter-rouge">run_attacker</code> just like in the spectre lab. (You have started the spectre lab, haven’t you? :D)</li> <li>The provided code will take care of guess generation, you take care of determining which guess was best.</li> <li>You will implement <code class="language-plaintext highlighter-rouge">do_guess</code> which issues one guess and returns the time it took.</li> <li>You will then handle cleanup and state synchronization so that the victim and attacker stay in sync. <ul> <li>We provide <code class="language-plaintext highlighter-rouge">sync_victim</code> that may help with this.</li> <li>Be careful not to deadlock.</li> </ul> </li> </ul> <h3 id="measuring-and-communicating-with-the-victim"> <a href="#measuring-and-communicating-with-the-victim" class="anchor-heading" aria-labelledby="measuring-and-communicating-with-the-victim"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Measuring and Communicating with the Victim </h3> <p>When we hooked the boards up in the wiring part of the experiment setup, we connected the victim’s LED pin to an attacker input pin (pin D2). So, by calling <code class="language-plaintext highlighter-rouge">digitalRead(2)</code>, we can see what the status of the victim light is. It will either be <code class="language-plaintext highlighter-rouge">HIGH</code> or <code class="language-plaintext highlighter-rouge">LOW</code> (macros defined for you to use by the Arduino toolchain).</p> <p>You can use the <code class="language-plaintext highlighter-rouge">esp_timer_get_time</code> method to read the current timestamp counter. By timing how long the light is on, you can time how long the victim spends in <code class="language-plaintext highlighter-rouge">memcmp</code>.</p> <p>Use <code class="language-plaintext highlighter-rouge">Serial2</code> to talk to the victim. You can use our wrapper methods <code class="language-plaintext highlighter-rouge">send_to_victim</code> and <code class="language-plaintext highlighter-rouge">read_byte_from_victim</code> or just use the <code class="language-plaintext highlighter-rouge">Serial2</code> device with the Serial API.</p> <h3 id="useful-methods"> <a href="#useful-methods" class="anchor-heading" aria-labelledby="useful-methods"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Useful methods </h3> <p>Here is a laundry list of useful methods you may want to use.</p> <ul> <li><code class="language-plaintext highlighter-rouge">uint64_t esp_timer_get_time()</code>: Reads from the processor high resolution timer register. Similar to the <code class="language-plaintext highlighter-rouge">rdtsc</code> instruction on x86.</li> <li><code class="language-plaintext highlighter-rouge">Serial.println(anything)</code>: Print this thing to the serial port. Can handle numbers, <code class="language-plaintext highlighter-rouge">char</code> arrays, <code class="language-plaintext highlighter-rouge">String</code>s, etc. Just like on Arduino.</li> <li><code class="language-plaintext highlighter-rouge">digitalRead(pin number)</code>: Returns the state of a given input pin (either <code class="language-plaintext highlighter-rouge">HIGH</code> or <code class="language-plaintext highlighter-rouge">LOW</code>).</li> <li><code class="language-plaintext highlighter-rouge">delay(time in ms)</code>: Delay for some number of milliseconds. Useful for syncing up between the two devices/ allowing transfers to finish.</li> <li>Helper functions in the starter code: <code class="language-plaintext highlighter-rouge">send_to_computer</code>, <code class="language-plaintext highlighter-rouge">send_to_victim</code>, <code class="language-plaintext highlighter-rouge">read_byte_from_computer</code>, and <code class="language-plaintext highlighter-rouge">read_byte_from_victim</code>. These are wrappers around the excellent Arduino libraries.</li> <li>Variable <code class="language-plaintext highlighter-rouge">Serial</code> talks to the computer, and <code class="language-plaintext highlighter-rouge">Serial2</code> talks to the victim.</li> <li>More references: <a href="https://www.arduino.cc/reference/en/language/variables/data-types/stringobject/">Arduino String Reference</a>, <a href="https://www.arduino.cc/reference/en/language/functions/communication/serial/">Arduino Serial Reference</a></li> </ul> <h3 class="no_toc" id="hints"> <a href="#hints" class="anchor-heading" aria-labelledby="hints"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Hints </h3> <ul> <li>If you are sending data too fast, the victim may not see it. Adding some <code class="language-plaintext highlighter-rouge">delay()</code>s while testing and then removing them later can’t hurt.</li> <li>You can use <code class="language-plaintext highlighter-rouge">Serial2.availableForWrite()</code> to check if the write buffer is busy. This might be able to help you stop sending data too fast.</li> <li>Take a look at the Arduino serial API, it helps a lot with implementing a serial protocol.</li> <li>Valid solutions have a 100% success rate and mine takes 1 minute 30 seconds to run.</li> </ul> <!-- ## Your Tasks 1. Perform any tests you want to do at `TODO1`. 1. Think about the state required for each test (`TODO2`). 1. Implement `do_guess` (`TODO3`). 1. Clean up after a guess (`TODO4` and `TODO5`). --> <!-- # Attack Now that we're all setup, it's time to actually attack the victim! - We want to reveal what the full secret string is - The victim will turn its light on when it is running `memcmp` and turn it off when it is done --> <h2 class="no_toc" id="image-credits"> <a href="#image-credits" class="anchor-heading" aria-labelledby="image-credits"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Image Credits </h2> <p>Apple, Adafruit, Espressif, Mouser, Bhphoto</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>

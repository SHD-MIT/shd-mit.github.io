<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/2025/assets/css/just-the-docs-default.css"> <script src="/2025/assets/js/vendor/lunr.min.js"></script> <script src="/2025/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>CPU Verification | 6.5950/6.5951</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="CPU Verification" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Secure Hardware Design" /> <meta property="og:description" content="Secure Hardware Design" /> <meta property="og:site_name" content="6.5950/6.5951" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="CPU Verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Secure Hardware Design","headline":"CPU Verification","url":"/2025/labs/formal.html"}</script> <!-- End Jekyll SEO tag --> <!-- Cover up the page while CSS is loading to prevent flicker --> <div id="preload-cover"></div> <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" /> <style> #preload-cover { position:fixed; height:100%; width:100%; top:0; left:0; background:#fff; z-index:9999; } @media (prefers-color-scheme: dark) { #preload-cover { position:fixed; height:100%; width:100%; top:0; left:0; background:#222326; z-index:9999; } } </style> <script> window.addEventListener('load', function() { var cover = document.getElementById('preload-cover'); cover.style.display = 'none'; }); </script> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Feather. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/2025/" class="site-title lh-tight"> 6.5950/6.5951 </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/2025/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/2025/calendar.html" class="nav-list-link">Calendar</a></li><li class="nav-list-item"><a href="/2025/lectureReadings.html" class="nav-list-link">Lecture Readings</a></li><li class="nav-list-item"><a href="/2025/paperDiscussion.html" class="nav-list-link">Paper Discussion</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Recitations category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/2025/recitations.html" class="nav-list-link">Recitations</a><ul class="nav-list "><li class="nav-list-item "><a href="/2025/recitations/cpp.html" class="nav-list-link">CTF of C Programming</a></li><li class="nav-list-item "><a href="/2025/recitations/cache.html" class="nav-list-link">Cache Recitation</a></li><li class="nav-list-item "><a href="/2025/recitations/physical.html" class="nav-list-link">CTF of Physical Attacks</a></li><li class="nav-list-item "><a href="/2025/recitations/riscv.html" class="nav-list-link">Binary Exploitation and RISC-V Warmup</a></li><li class="nav-list-item "><a href="/2025/recitations/formal.html" class="nav-list-link">Formal Verification</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Labs category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/2025/labs.html" class="nav-list-link">Labs</a><ul class="nav-list "><li class="nav-list-item "><a href="/2025/labs/ccc.html" class="nav-list-link">C Crash Course</a></li><li class="nav-list-item "><a href="/2025/labs/fingerprinting.html" class="nav-list-link">Website Fingerprinting</a></li><li class="nav-list-item "><a href="/2025/labs/cache.html" class="nav-list-link">Cache Attacks</a></li><li class="nav-list-item "><a href="/2025/labs/spectre.html" class="nav-list-link">Spectre Attacks</a></li><li class="nav-list-item "><a href="/2025/labs/rowhammer.html" class="nav-list-link">Rowhammer</a></li><li class="nav-list-item "><a href="/2025/labs/aslr.html" class="nav-list-link">ASLR Bypasses</a></li><li class="nav-list-item "><a href="/2025/labs/psp.html" class="nav-list-link">Pretty Secure Processor</a></li><li class="nav-list-item "><a href="/2025/labs/fuzz.html" class="nav-list-link">CPU Fuzzing</a></li><li class="nav-list-item active"><a href="/2025/labs/formal.html" class="nav-list-link active">CPU Verification</a></li></ul></li><li class="nav-list-item"><a href="/2025/paperReadingGuidance.html" class="nav-list-link">Paper Readings Guidance</a></li><li class="nav-list-item"><a href="/2025/forInstructors.html" class="nav-list-link">For Instructors</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search 6.5950/6.5951" aria-label="Search 6.5950/6.5951" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <span id="dark-light-switch" class="material-symbols-outlined"></span> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/2025/labs.html">Labs</a></li> <li class="breadcrumb-nav-list-item"><span>CPU Verification</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 class="no_toc" id="cpu-verification-lab"> <a href="#cpu-verification-lab" class="anchor-heading" aria-labelledby="cpu-verification-lab"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CPU Verification Lab </h1> <p><strong>Due Date: May 13</strong>; Last Updated Date: Jan 14</p> <h2 class="no_toc" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of Contents </h2> <ul id="markdown-toc"> <li><a href="#overview-formally-verify-the-psp" id="markdown-toc-overview-formally-verify-the-psp">Overview: Formally Verify the PSP</a> <ul> <li><a href="#your-verification-task" id="markdown-toc-your-verification-task">Your Verification Task</a></li> <li><a href="#code-structure" id="markdown-toc-code-structure">Code Structure</a></li> </ul> </li> <li><a href="#part-1-get-familiar-with-the-starter-code" id="markdown-toc-part-1-get-familiar-with-the-starter-code">Part 1: Get Familiar with the Starter Code</a> <ul> <li><a href="#part-1a-specification-code-20" id="markdown-toc-part-1a-specification-code-20">Part 1A: Specification Code (20%)</a></li> <li><a href="#part-1b-implementation-code-5" id="markdown-toc-part-1b-implementation-code-5">Part 1B: Implementation Code (5%)</a></li> <li><a href="#part-1c-verification-code-10" id="markdown-toc-part-1c-verification-code-10">Part 1C: Verification Code (10%)</a></li> </ul> </li> <li><a href="#part-2-find-the-adder-bug-5" id="markdown-toc-part-2-find-the-adder-bug-5">Part 2: Find the Adder Bug (5%)</a></li> <li><a href="#part-3-find-the-backdoor-instruction" id="markdown-toc-part-3-find-the-backdoor-instruction">Part 3: Find the Backdoor Instruction</a> <ul> <li><a href="#simplications-on-the-original-psp-processor" id="markdown-toc-simplications-on-the-original-psp-processor">Simplications on the Original PSP Processor</a></li> <li><a href="#part-3a-add-exceptions-in-the-specification-20" id="markdown-toc-part-3a-add-exceptions-in-the-specification-20">Part 3A: Add Exceptions in the Specification (20%)</a></li> <li><a href="#part-3b-find-the-backdoor-instruction-40" id="markdown-toc-part-3b-find-the-backdoor-instruction-40">Part 3B: Find the Backdoor Instruction (40%)</a></li> </ul> </li> </ul> <h2 class="no_toc" id="lab-details"> <a href="#lab-details" class="anchor-heading" aria-labelledby="lab-details"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Lab Details </h2> <h3 class="no_toc" id="collaboration-policy"> <a href="#collaboration-policy" class="anchor-heading" aria-labelledby="collaboration-policy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Collaboration Policy </h3> <p>Our full Academic Honesty policy can be found on the <a href="../index.html#collaboration-policy">Course Information page</a> of our website. As a reminder, all 6.5950/6.5951 labs should be completed individually. You may discuss the lab at a high level with a classmate, but you may not work on code together or share any of your code.</p> <h3 class="no_toc" id="getting-started"> <a href="#getting-started" class="anchor-heading" aria-labelledby="getting-started"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Getting Started </h3> <p>This lab could be run on our lab machine <code class="language-plaintext highlighter-rouge">unicorn.csail.mit.edu</code>. Log in with the same user account as previous labs.</p> <p>Alternatively, you can use the docker file provided in the starter code to run the lab locally. Instructions to run the docker are provided <a href="../labs.html#alternative-docker-environment">here</a>.</p> <h2 id="overview-formally-verify-the-psp"> <a href="#overview-formally-verify-the-psp" class="anchor-heading" aria-labelledby="overview-formally-verify-the-psp"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview: Formally Verify the PSP </h2> <p>In the <a href="../labs/fuzz.html">Fuzzing Lab</a>, you have been playing with the buggy Pretty Secure Processor and found the ALU bug and the backdoor instruction. In this lab, you will try to find them again with another approach – Model Checking – as you have learned from the <a href="../recitations/formal.html">Formal Verification Recitation</a>. Hope you will have a better understanding and comparison of fuzzing and formal verification.</p> <blockquote class="hint-title"> <p>Finish the Recitation First!</p> <p>If you have not finished the Formal Verification Recitation, stop continuing on the lab and finish the Recitation first! The recitation is basically a simpler version of the lab and gets you familiar with the whole verification framework. A solution to the recitation has been provided on Piazza.</p> </blockquote> <h3 id="your-verification-task"> <a href="#your-verification-task" class="anchor-heading" aria-labelledby="your-verification-task"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Your Verification Task </h3> <p>As explained in the <a href="../recitations/formal.html#the-big-picture">“The Big Picture” Section</a> of the Recitation, the basic idea of formal verification is to check the <strong>implementation</strong> matches the <strong>specification</strong> under <strong>all possible inputs</strong> to the hardware. In this lab, the 3 key components of this task are:</p> <ul> <li><strong>Implementation</strong>: Verilog source code of the PSP Processor.</li> <li><strong>Specification</strong>: (A small portion of) RISC-V ISA definition.</li> <li><strong>Covering all possible inputs</strong>: Use Rosette, a symbolic execution framework.</li> </ul> <h3 id="code-structure"> <a href="#code-structure" class="anchor-heading" aria-labelledby="code-structure"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Code Structure </h3> <p>You will gradually write the code to achieve this verification task. Here is an overview of the starter code structure, which is similar to the code structure in the Recitation. We will guide you through the starter code in Part 1 of this lab.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|-- core_to_verify         # System Verilog code of PSP
|   |-- ...
|   `-- core_to_verify.sv  # Top module
|
|-- scripts
|   |-- sv2rkt.sh          # Convert System Verilog to Rosette
|   |-- yosys_command.ys   # yosys commands used by `sv2rkt.sh`
|   `-- verify.sh          # Run the verification
|
|-- generated_src
|   `-- core_to_verify.rkt # Rosette code generated through `sv2rkt.sh`
|
`-- src           # Contain all verification code
    |-- param     # Parameters like instructions encodings
    |   `-- ...
    |-- array     # Functions operating on register arrays
    |   `-- ...
    |-- impl.rkt  # Functions to simulate the implementation
    |-- spec.rkt  # Functions to simulate the specification
    `-- veri.rkt  # Simulate the impl and spec and verify they match
</code></pre></div></div> <h2 id="part-1-get-familiar-with-the-starter-code"> <a href="#part-1-get-familiar-with-the-starter-code" class="anchor-heading" aria-labelledby="part-1-get-familiar-with-the-starter-code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Part 1: Get Familiar with the Starter Code </h2> <p>The processor you will verify this time will be more complex than the one in the Recitation. It could be hard to directly jump into the implementation part of the processor. So, let’s start by looking at the specification. The specification is used to represent how architecture states should be updated by each instruction. It does not need to reflect how long (i.e. how many cycles) an instruction should take in a real (pipelined / Out-of-Order) processor and we can just write a specification that executes 1 instruction per cycle for convenience.</p> <h3 id="part-1a-specification-code-20"> <a href="#part-1a-specification-code-20" class="anchor-heading" aria-labelledby="part-1a-specification-code-20"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Part 1A: Specification Code (20%) </h3> <p>We will look at <code class="language-plaintext highlighter-rouge">spec.rkt</code> and the 3 files it requires (i.e., imports), <code class="language-plaintext highlighter-rouge">array/rf.rkt</code>, <code class="language-plaintext highlighter-rouge">array/imem.rkt</code>, and <code class="language-plaintext highlighter-rouge">param/inst.rkt</code> in this part. The following exercises and discussions are designed to help you understand them.</p> <p><strong>Run a Test Program</strong></p> <blockquote class="exercise-title"> <p>1-1 Exercise</p> <p>The main function of the <code class="language-plaintext highlighter-rouge">spec.rkt</code> file (i.e., the last line in it) contains a single function call to the <code class="language-plaintext highlighter-rouge">testMe</code> function. Run the <code class="language-plaintext highlighter-rouge">spec.rkt</code> file with <code class="language-plaintext highlighter-rouge">racket src/spec.rkt</code> command from the root folder in the terminal. Check the terminal output.</p> </blockquote> <blockquote class="hint-title"> <p>Broken Environment</p> <p>In case the command above returns <code class="language-plaintext highlighter-rouge">-bash: racket: command not found</code> on <code class="language-plaintext highlighter-rouge">unicorn</code>, try <code class="language-plaintext highlighter-rouge">source /knox/envSetup.sh</code> to set environment variables. (This should not happen normally because this source command should be run automatically when you log in.)</p> </blockquote> <p>The code you just ran initializes an instance of the specification data structure and simulates it by 5 cycles. The states of the specification are printed out at each cycle. You will be asked to explain this output along with the source code of <code class="language-plaintext highlighter-rouge">testMe</code> function in the following discussion question.</p> <blockquote class="hint-title"> <p>HINT: Rosette Libraries</p> <p>Forget the meaning of a built-in function? You can:</p> <ul> <li>Check the <a href="../recitations/formal.html#learn-rosette-syntax">“Learn Rosette Syntax” Section</a> from the Recitation for basic keywords/functions including <code class="language-plaintext highlighter-rouge">define</code>, <code class="language-plaintext highlighter-rouge">struct</code>, <a href="https://docs.racket-lang.org/rosette-guide/sec_bitvectors.html"><code class="language-plaintext highlighter-rouge">bitvector</code></a>, <a href="https://docs.racket-lang.org/reference/vectors.html"><code class="language-plaintext highlighter-rouge">vector</code></a>, <code class="language-plaintext highlighter-rouge">printf</code>, branch and loops.</li> <li>Search the function in <a href="https://docs.racket-lang.org/">Racket’s official document page</a>, by putting the function name into the search box at the left-top corner. If you find multiple searched results, use the function “provided from /rosette/…”.</li> </ul> </blockquote> <blockquote class="discussion-title"> <p>1-2 Discussion Question</p> <ol> <li>Which function is called to initialize the variable <code class="language-plaintext highlighter-rouge">spec</code>? What is the data type of this variable?</li> <li>What are the instructions stored in the initial instruction memory? How about the initial content of the data memory and register file? (Hint: find the file where <code class="language-plaintext highlighter-rouge">init-debug-imem</code>, <code class="language-plaintext highlighter-rouge">init-zero-dmem</code>, and <code class="language-plaintext highlighter-rouge">init-zero-rf</code> are defined.)</li> <li>Move on to the simulation of <code class="language-plaintext highlighter-rouge">spec</code>. The function <code class="language-plaintext highlighter-rouge">step-spec!</code> is called to simulate it by 1 cycle. In this function, what is the function <code class="language-plaintext highlighter-rouge">spec-pc</code> doing?</li> <li>The function <code class="language-plaintext highlighter-rouge">inst-rd</code> is defined in <code class="language-plaintext highlighter-rouge">param/inst.rkt</code>. What is it doing? (Hint: <code class="language-plaintext highlighter-rouge">extract</code> is a built-in function you could search in the <a href="https://docs.racket-lang.org/">Racket’s official document page</a>)</li> <li>In the starter code of <code class="language-plaintext highlighter-rouge">step-spec!</code>, what instruction has already been supported?</li> </ol> </blockquote> <p>Now you should have a general idea about what <code class="language-plaintext highlighter-rouge">spec.rkt</code> is doing. Read through the file and confirm you understand the 5 key functions it defines, summarized in the table below. They will be used during the verification.</p> <div class="table-wrapper"><table> <thead> <tr> <th>Function</th> <th>Explanation</th> </tr> </thead> <tbody> <tr> <td>(<strong>init-spec</strong> imem dmem)</td> <td>Initialize an instance of <code class="language-plaintext highlighter-rouge">spec</code> data structure and return it.</td> </tr> <tr> <td>(<strong>step-spec!</strong> spec)</td> <td>Simulate the specification by 1 cycle.</td> </tr> <tr> <td>(<strong>spec-archState</strong> spec)</td> <td>Extract the architectural state of the specification that will be compared with the implementation.</td> </tr> <tr> <td>(<strong>spec-justCommit</strong> spec)</td> <td>Indicate whether the <code class="language-plaintext highlighter-rouge">spec</code> just committed an instruction during the last time <code class="language-plaintext highlighter-rouge">step-spec!</code> is called. This function is implicitly defined when we define the <code class="language-plaintext highlighter-rouge">struct spec</code>.</td> </tr> <tr> <td>(<strong>spec-&gt;string</strong> spec)</td> <td>Convert the <code class="language-plaintext highlighter-rouge">spec</code> data structure to string for a nice printing. (Yes, <code class="language-plaintext highlighter-rouge">-&gt;</code> can be part of the function name.)</td> </tr> </tbody> </table></div> <p><strong>Support 4 More Instructions</strong></p> <p>Now that you have been familiar with the starter code of the specification, let’s extend it a little bit to test your understanding.</p> <blockquote class="exercise-title"> <p>1-3 Exercise</p> <p>Following the pattern of how <code class="language-plaintext highlighter-rouge">step-spec!</code> executes LUI instruction, extend it to support ADDI, SRLI, ADD, and BEQ instructions. Some helper functions to decode instructions are provided in <code class="language-plaintext highlighter-rouge">param/inst.rkt</code>.</p> <p>You could test your code by updating the <code class="language-plaintext highlighter-rouge">init-debug-imem</code> function in <code class="language-plaintext highlighter-rouge">array/imem.rkt</code> to include these new instructions, and run it with <code class="language-plaintext highlighter-rouge">racket src/spec.rkt</code> from the root folder (where you will run all the rest commands in this lab) in the terminal.</p> </blockquote> <blockquote class="hint-title"> <p>HINT: ISA Definitions</p> <p>Please refer to <a href="https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf">ISA Specification</a>, starting at Page 18, for the detailed explanation of each instruction. A summary of these instructions is on Page 130.</p> </blockquote> <blockquote class="hint"> <p>If you are confused by what <code class="language-plaintext highlighter-rouge">(assume #f)</code> is doing in the <code class="language-plaintext highlighter-rouge">else</code> case of the <code class="language-plaintext highlighter-rouge">cond</code> block, don’t worry, you do not need to change it in this exercise, and we will talk about it <a href="#part-1c-verification-code-10">later</a>.</p> </blockquote> <h3 id="part-1b-implementation-code-5"> <a href="#part-1b-implementation-code-5" class="anchor-heading" aria-labelledby="part-1b-implementation-code-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Part 1B: Implementation Code (5%) </h3> <p>Writing the specification code above is nothing more than writing a normal program, but in our newly learned Rosette language. In this part, however, you will explore more power of the framework and simulate the Verilog code cycle by cycle.</p> <p>Most of the implementation code is automatically generated by the <a href="https://yosyshq.net/yosys/">yosys</a>+<a href="https://github.com/anishathalye/knox">knox</a> you have used in the <a href="../recitations/formal.html#from-rtl-to-rosette">“From RTL to Rosette” Section</a> of Recitation. As you have seen in the <a href="../recitations/formal.html#exercise-1-interact-with-tiny-cpu-in-rosette">Exercise 1</a> of the Recitation, this automatically generated code provides interface functions to initialize the state of a Verilog module, simulate it, and extract the output from it. The <code class="language-plaintext highlighter-rouge">impl.rkt</code> file uses these interface functions to define 5 functions for our verification (, which are similar to the functions defined in the <code class="language-plaintext highlighter-rouge">spec.rkt</code> file):</p> <div class="table-wrapper"><table> <thead> <tr> <th>Function</th> <th>Explanation</th> </tr> </thead> <tbody> <tr> <td>(<strong>init-impl</strong> imem dmem)</td> <td>Initialize an instance of <code class="language-plaintext highlighter-rouge">impl</code> data structure and return it.</td> </tr> <tr> <td>(<strong>step-impl!</strong> impl)</td> <td>Simulate the implementation by 1 cycle.</td> </tr> <tr> <td>(<strong>impl-archState</strong> impl)</td> <td>Extract the architectural state of the implementation that will be compared with the specification.</td> </tr> <tr> <td>(<strong>impl-justCommit</strong> impl)</td> <td>Indicate whether the <code class="language-plaintext highlighter-rouge">impl</code> just commit an instruction during the last time <code class="language-plaintext highlighter-rouge">step-impl!</code> is called.</td> </tr> <tr> <td>(<strong>impl-&gt;string</strong> impl)</td> <td>Convert the <code class="language-plaintext highlighter-rouge">impl</code> data structure to string for a nice printing.</td> </tr> </tbody> </table></div> <p>All these functions are provided in the file <code class="language-plaintext highlighter-rouge">impl.rkt</code>. You do not need to fully understand how these functions are implemented and only need to know how to use them. Specifically, you will run a <code class="language-plaintext highlighter-rouge">testMe</code> function in it to see how a Verilog module is simulated with a concrete instruction memory.</p> <blockquote class="exercise-title"> <p>1-4 Exercise</p> <p>Generate the <code class="language-plaintext highlighter-rouge">.rkt</code> file (i.e., <code class="language-plaintext highlighter-rouge">generated_src/core_to_verify.rkt</code>) from the System Verilog files by running <code class="language-plaintext highlighter-rouge">./scripts/sv2rkt.sh</code>.</p> <p>Run the <code class="language-plaintext highlighter-rouge">impl.rkt</code> file with <code class="language-plaintext highlighter-rouge">racket src/impl.rkt</code> command. Check the terminal output.</p> </blockquote> <blockquote class="discussion-title"> <p>1-5 Discussion Question</p> <p>Check the output of <code class="language-plaintext highlighter-rouge">racket src/impl.rkt</code> and answer: After simulating how many cycles did you observe the first and the second instructions being committed? Could you explain the reason for these two cycle numbers based on <a href="../labs/fuzz.html#what-happens-when-i-run-my-code">the micro-architecture of the pretty secure processor</a>?</p> </blockquote> <p>If you are curious about how these functions are implemented, feel free to read through the <code class="language-plaintext highlighter-rouge">impl.rkt</code> file. There are many comments to explain the code. They are implemented with two key ideas in mind:</p> <ul> <li>To simulate the pipeline of the processor, it uses the interface functions provided by the generated code from the yosys+knox toolchain. This is similar to how we simulate the Tiny CPU in the Recitation.</li> <li>It also simulates the interaction between the pipeline and the instruction/data memory. The memory takes 1 cycle to return the data: At cycle 0, it saves the inputs to a buffer register; At cycle 1, it returns the data.</li> </ul> <h3 id="part-1c-verification-code-10"> <a href="#part-1c-verification-code-10" class="anchor-heading" aria-labelledby="part-1c-verification-code-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Part 1C: Verification Code (10%) </h3> <p>Finally, we will start to do the verification! We will help you understand the <code class="language-plaintext highlighter-rouge">veri.rkt</code> file. It uses the 5 key functions from <code class="language-plaintext highlighter-rouge">spec.rkt</code> and the 5 from <code class="language-plaintext highlighter-rouge">impl.rkt</code> that you should already be familiar with. It also requires (i.e., imports) a small configuration file <code class="language-plaintext highlighter-rouge">param/veri.rkt</code> that will be explained later.</p> <p><strong>Verify a Concrete Test Program</strong></p> <p>Normally, we want to verify the specification and implementation match under any initial state of the instruction memory. This requires us to initialize the instruction memory with symbolic values (with the function <code class="language-plaintext highlighter-rouge">init-sym-imem</code> in <code class="language-plaintext highlighter-rouge">array/imem.rkt</code>). However, this might be inconvenient for us to debug or just to learn the code. Thus, let’s first try to run the framework with a concrete initial instruction memory, which essentially means we want to verify the specification and implementation match under a concrete program. We provide a simple variable in <code class="language-plaintext highlighter-rouge">param/veri.rkt</code>, the <code class="language-plaintext highlighter-rouge">param-imem-type</code> to determine whether to use symbolic or concrete initial instruction memory. Let’s start by setting the variable to “concrete” first.</p> <blockquote class="exercise-title"> <p>1-6 Exercise</p> <p>Change the <code class="language-plaintext highlighter-rouge">param-imem-type</code> variable in <code class="language-plaintext highlighter-rouge">param/veri.rkt</code> to “concrete” and run the <code class="language-plaintext highlighter-rouge">veri.rkt</code> file with <code class="language-plaintext highlighter-rouge">racket src/veri.rkt</code>.</p> <p>You should see “No Counterexample” at the end of the terminal output. If not, it means the specification and the implementation mismatch when running the program returned by the <code class="language-plaintext highlighter-rouge">init-debug-imem</code> function in <code class="language-plaintext highlighter-rouge">array/imem.rkt</code> – You probably did Exercise 1-3 incorrectly.</p> </blockquote> <p>Now, let me ask you a few questions to help you understand the output and the source code (i.e., the <code class="language-plaintext highlighter-rouge">testMe</code> function in <code class="language-plaintext highlighter-rouge">veri.rkt</code>). But before that, let me remind you of a few build-in functions for the verification in Rosette (that you will see in <code class="language-plaintext highlighter-rouge">veri.rkt</code>):</p> <div class="table-wrapper"><table> <thead> <tr> <th>Function</th> <th>Explanation</th> </tr> </thead> <tbody> <tr> <td>(<strong>verify</strong> expr)</td> <td>Symbolically execute the <code class="language-plaintext highlighter-rouge">expr</code>. At the end of the execution, send all assumptions and assertions generated by <code class="language-plaintext highlighter-rouge">expr</code> to an SMT solver, asking for a solution (i.e., a counterexample satisfying all the assumptions but violating one of the assertions). The solution is returned.</td> </tr> <tr> <td>(<strong>sat?</strong> sol)</td> <td>Return true if the solution (<code class="language-plaintext highlighter-rouge">sol</code>) indeed finds a counterexample.</td> </tr> <tr> <td>(<strong>evaluate</strong> v sol)</td> <td>In the counterexample shown in the solution (<code class="language-plaintext highlighter-rouge">sol</code>), what is the concrete instance of variable <code class="language-plaintext highlighter-rouge">v</code>? This function returns the concrete instance.</td> </tr> </tbody> </table></div> <blockquote class="discussion-title"> <p>1-7 Discussion Question</p> <ol> <li>When executing the line of code <code class="language-plaintext highlighter-rouge">(verify (simu imem dmem #f))</code> in <code class="language-plaintext highlighter-rouge">veri.rkt</code>, what are the assertions generated?</li> <li>In the <code class="language-plaintext highlighter-rouge">for</code> loop of function <code class="language-plaintext highlighter-rouge">simu</code>, the implementation and specification are simulated in a “synchronized” manner. What could go wrong if we just simulate both of them by 1 cycle in each loop iteration, without changing other code?</li> </ol> </blockquote> <p><strong>Test on Finding a Counterexample</strong></p> <p>It is not essentially fun to see no counterexample found. After all, we try to find bugs with our framework in the lab. So, let’s manually create a mismatch between the specification and the implementation and see how will the framework react.</p> <blockquote class="exercise-title"> <p>1-8 Exercise</p> <p>Go to the <code class="language-plaintext highlighter-rouge">step-spec!</code> function in <code class="language-plaintext highlighter-rouge">spec.rkt</code> and look at the code that executes the LUI instruction. Let’s change the line <code class="language-plaintext highlighter-rouge">(write-rf! rf rd imm-U)</code> to <code class="language-plaintext highlighter-rouge">(write-rf! rf rd (bv 0 32))</code> and then run <code class="language-plaintext highlighter-rouge">racket src/veri.rkt</code> again.</p> </blockquote> <p>Now, our specification and implementation will definitely mismatch because the specification is not executing the LUI instruction correctly. Let’s look at the terminal output and see how the framework figures out this mismatch.</p> <p>Here is how the code in <code class="language-plaintext highlighter-rouge">veri.rkt</code> works:</p> <ul> <li>Line <code class="language-plaintext highlighter-rouge">(define sol (verify (simu imem dmem #f)))</code> simulates the specification and implementation. At the end of the simulation, it queries the SMT solver and finds a solution that contains a counterexample.</li> <li>Line <code class="language-plaintext highlighter-rouge">(set! imem (evaluate imem sol))</code> looks into the counterexample in the <code class="language-plaintext highlighter-rouge">sol</code> and finds the concrete value of the instruction memory that triggers the assertion false. It updates the variable <code class="language-plaintext highlighter-rouge">imem</code> with this concrete value. (For now, this concrete imem is just the one you define in <code class="language-plaintext highlighter-rouge">array/imem.rkt</code>.)</li> <li>Line <code class="language-plaintext highlighter-rouge">(simu imem dmem #t)</code> simulates the specification and implementation again with this concrete instruction memory. It will print out a trace to show the counterexample.</li> </ul> <blockquote class="discussion-title"> <p>1-9 Discussion Question</p> <p>Check the terminal output and answer: after finishing simulating which cycle does the implementation and specification start to mismatch on the architectural state? What is the mismatch? Why do we have this mismatch?</p> </blockquote> <p><strong>Find a Counterexample with Symbolic Initial Instruction Memory</strong></p> <p>Now, let’s change the initial state of the instruction memory to symbolic value and release the full power of our framework.</p> <blockquote class="exercise-title"> <p>1-10 Exercise</p> <p>Change the <code class="language-plaintext highlighter-rouge">param-imem-type</code> variable in <code class="language-plaintext highlighter-rouge">param/veri.rkt</code> to “sym” and run <code class="language-plaintext highlighter-rouge">racket src/veri.rkt</code>.</p> </blockquote> <blockquote class="discussion-title"> <p>1-11 Discussion Question</p> <p>This time, what instruction triggers the mismatch in the architectural state at which cycle?</p> </blockquote> <blockquote class="hint-title"> <p>Debug with Concrete imem</p> <p>Whenever your code does not work properly later in this lab, with symbolic initial instructions, you can always switch back to concrete initial instructions for debugging.</p> </blockquote> <p><strong>Constraint the Search Space</strong></p> <p>You might face a small trouble in investigating the counterexample in the last run: the concrete instruction is executing on a register whose index is quite large. However, our terminal only prints out the registers with index 0, 1, 2, and 3, due to the space limit. To see the value stored in this register with a large index, we have to adjust the printing function to include the specific register in the printings.</p> <p>It could be annoying to do this for every new counterexample. We provide a convenient configuration variable to solve this problem: The <code class="language-plaintext highlighter-rouge">param-limit-space</code> in <code class="language-plaintext highlighter-rouge">param/veri.rkt</code> can be used to limit the search space of the solver by only considering the register file accesses whose indexes are within [0, 3] and memory requests whose addresses are within [0x0, 0x1f]. Let’s try it.</p> <blockquote class="exercise-title"> <p>1-12 Exercise</p> <p>Change the <code class="language-plaintext highlighter-rouge">param-limit-space</code> variable in <code class="language-plaintext highlighter-rouge">param/veri.rkt</code> to <code class="language-plaintext highlighter-rouge">#t</code> and run <code class="language-plaintext highlighter-rouge">racket src/veri.rkt</code>. We will keep it to <code class="language-plaintext highlighter-rouge">#t</code> for the rest of the lab.</p> </blockquote> <p>Now, you should be able to see the counterexample uses a register with a smaller index and the state mismatch can be easily checked from the terminal printout.</p> <p><strong>Assumptions and Assertions</strong></p> <p>The <code class="language-plaintext highlighter-rouge">param-limit-space</code> configuration you just tried is no more than achieving a small engineering trick to help us debug. However, we want to bring your attention to how it is implemented, which will reveal a more fundamental concept in the formal verification – Constraining the search space with Assumptions.</p> <p>You have already been familiar with the assertions, right? Basically, whenever you want to check a property, you assert it. Assumptions, on the other hand, have also been used in the code base a few times without being fully explained to you. Let’s take one example you just used to explain it. Check out the <code class="language-plaintext highlighter-rouge">write-rf!</code> function in <code class="language-plaintext highlighter-rouge">array/rf.rkt</code>. The <code class="language-plaintext highlighter-rouge">assume</code> is called to assume the higher 3 bits of the register index (i.e., <code class="language-plaintext highlighter-rouge">pos</code>) is always zero. You have just benefited from this assumption in a way that the counterexample generated only uses a register whose index is within [0, 3]. Here is a summary of how assumptions work:</p> <ul> <li>During the symbolic simulation, all expressions being assumed by the <code class="language-plaintext highlighter-rouge">assume</code> function are collected, in the same way the assertions are collected.</li> <li>When querying the SMT solver, instead of just asking the SMT solver to find a counterexample violating the assertions, we now ask for a counterexample, i.e., a concrete instance of instruction memory, that satisfies all assumptions but still violates some assertions.</li> </ul> <p>In our example, the assumption in this <code class="language-plaintext highlighter-rouge">write-rf!</code> function makes sure the program in the counterexample will not use a register with larger indexes. Assumptions help us constrain the search space for those symbolic values.</p> <p>Another place where you have been benefiting from assumption is the <code class="language-plaintext highlighter-rouge">step-spec!</code> function in the <code class="language-plaintext highlighter-rouge">spec.rkt</code> file. When an instruction type has not been supported (i.e., in the <code class="language-plaintext highlighter-rouge">else</code> case of the <code class="language-plaintext highlighter-rouge">cond</code> block), we use <code class="language-plaintext highlighter-rouge">(assume #f)</code>. This makes sure programs using unsupported instructions will not be considered (as a counterexample).</p> <blockquote class="hint-title"> <p>HINT: Use <code class="language-plaintext highlighter-rouge">assume</code>!</p> <p>If you could have a good understanding of <code class="language-plaintext highlighter-rouge">assume</code> and take advantage of it later in the lab, it could save you a lot of coding efforts while finding the same bug you are asked for.</p> </blockquote> <blockquote class="exercise-title"> <p>1-13 Exercise</p> <p>Go to the <code class="language-plaintext highlighter-rouge">step-spec!</code> function in <code class="language-plaintext highlighter-rouge">spec.rkt</code> and look at the code that executes the LUI instruction. Change the line <code class="language-plaintext highlighter-rouge">(write-rf! rf rd (bv 0 32))</code> back to <code class="language-plaintext highlighter-rouge">(write-rf! rf rd imm-U)</code>, run <code class="language-plaintext highlighter-rouge">racket src/veri.rkt</code>, and you should see “no counterexample found”.</p> </blockquote> <p>Now, you are ready to go with real challenges!</p> <h3 class="no_toc" id="grading"> <a href="#grading" class="anchor-heading" aria-labelledby="grading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Grading </h3> <p>The only code that we will grade for this part is Exercise 1-3. Other exercises are helping you to understand the framework and answer the discussion questions. The discussion questions will be graded.</p> <h2 id="part-2-find-the-adder-bug-5"> <a href="#part-2-find-the-adder-bug-5" class="anchor-heading" aria-labelledby="part-2-find-the-adder-bug-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Part 2: Find the Adder Bug (5%) </h2> <p>It is rather simple to find the adder bug after we have built up the framework. In fact, we already have all the code required to find this bug. The only thing you need to do in this part is to ask the model checker to check for more cycles.</p> <p><strong>Bounded Model Checking</strong></p> <p>We are doing a bounded model checking here, which means we only simulate the implementation for a bounded number of cycles and check whether the mismatch happens within this number of cycles. When it passes the check, it does not mean the implementation is fully correct and more bugs might be found when increasing the number of the bound. The number of the bound in our code base is defined in <code class="language-plaintext highlighter-rouge">param/veri.rkt</code> by the variable <code class="language-plaintext highlighter-rouge">param-simuCycle</code>.</p> <blockquote class="exercise-title"> <p>2-1 Exercise</p> <p>Increase the value of <code class="language-plaintext highlighter-rouge">param-simuCycle</code> in <code class="language-plaintext highlighter-rouge">param/veri.rkt</code> and redo the verification, until you could find the adder bug. (You might want to have a minimal <code class="language-plaintext highlighter-rouge">param-simuCycle</code>, so your counterexample showing the bug will also be short.)</p> </blockquote> <blockquote class="discussion-title"> <p>2-2 Discussion</p> <p>Describe the adder bug you found here.</p> </blockquote> <h3 class="no_toc" id="grading-1"> <a href="#grading-1" class="anchor-heading" aria-labelledby="grading-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Grading </h3> <p>The exercise in this part will not be graded, and only the discussion question will be graded.</p> <h2 id="part-3-find-the-backdoor-instruction"> <a href="#part-3-find-the-backdoor-instruction" class="anchor-heading" aria-labelledby="part-3-find-the-backdoor-instruction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Part 3: Find the Backdoor Instruction </h2> <p>Honestly, you have merely written any code so far in this lab, but just exploring the capability of the starter code. But now, it’s your turn to do some work.</p> <p>Recall in the Fuzzing Lab, the backdoor instruction is an instruction with illegal encoding. Based on the specification, this illegal instruction should cause an exception. However, the implementation does something different – it is executed as a nop or even silently changes the privilege level. In this part, you will try to describe the behavior of illegal instructions (i.e., causing exceptions) in the specification and automatically find that a backdoor instruction mismatches this behavior. For simplicity, you do not have to find when this backdoor instruction will change the privilege level.</p> <h3 id="simplications-on-the-original-psp-processor"> <a href="#simplications-on-the-original-psp-processor" class="anchor-heading" aria-labelledby="simplications-on-the-original-psp-processor"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Simplications on the Original PSP Processor </h3> <p>The original PSP processor supports tens of instructions as well as many CSRs. It could be tedious for you to implement all of them in the specification. So we have simplified the Verilog code of the PSP processor and we list a summary of it:</p> <ul> <li> <p>Only support 10 instructions: LUI, BEQ, LW, SW, ADDI, SRLI, ADD, ECALL, CSRRW, and MRET. The encodings of these instructions have been provided in <code class="language-plaintext highlighter-rouge">param/inst.rkt</code>. But you need to check the <a href="./psp.html#documentation-where-do-i-learn-more">ISA Specifications</a> for the expected behavior for each of them.</p> </li> <li> <p>Only support 3 CSRs: mtvec, mepc, and mpp. They are all zero after reset. Recall we have explained these CSRs <a href="../labs/psp.html#what-are-csrs">here</a>. Writing to any other CSRs will have no effect and reading from any other CSRs will return 0. Writing or reading to any other CSRs also will not check the privilege level or trigger exceptions.</p> </li> <li> <p>Only support 2 privilege levels: User Mode and Machine Mode. A 2-bit register stores the mode: 0 as User Mode and 3 as Machine Mode. The processor is in the Machine Mode after reset.</p> </li> <li> <p>When loading from or storing to an address that is misaligned (i.e., lower 2 bits are not zero), treat it as if the address is aligned (i.e., pretend the lower 2 bits are zero). This is the case for both instruction and data memories.</p> </li> </ul> <h3 id="part-3a-add-exceptions-in-the-specification-20"> <a href="#part-3a-add-exceptions-in-the-specification-20" class="anchor-heading" aria-labelledby="part-3a-add-exceptions-in-the-specification-20"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Part 3A: Add Exceptions in the Specification (20%) </h3> <p>The first step is to specify the behavior of Exceptions in the specification. The expected behavior of exceptions can be complex when many CSRs are involved. Thankfully, we only need to support 3 CSRs. Instead of pointing you to the official document of exceptions, which contains many CSR names that might scare you, here is a short summary of the expected behavior of exceptions in our simplified processor:</p> <ul> <li>Store the current <code class="language-plaintext highlighter-rouge">pc</code> to <code class="language-plaintext highlighter-rouge">mepc</code> and jump to the location stored in <code class="language-plaintext highlighter-rouge">mtvec</code>.</li> <li>Store the current (zero-extended-to-32-bit) privilege level to <code class="language-plaintext highlighter-rouge">mpp</code> and set the privilege level to Machine Mode.</li> <li>The current instruction will not be committed.</li> </ul> <blockquote class="exercise-title"> <p>3-1 Exercise</p> <p>Look at the <code class="language-plaintext highlighter-rouge">step-spec!</code> function in <code class="language-plaintext highlighter-rouge">spec.rkt</code>. When having an illegal (or currently unsupported) instruction, instead of doing <code class="language-plaintext highlighter-rouge">(assume #f)</code>, trigger the exception as described above. Some CSR-related codes are provided in <code class="language-plaintext highlighter-rouge">array/csr.rkt</code>.</p> <p>Test your code by adding an illegal (or currently unsupported) instruction to the <code class="language-plaintext highlighter-rouge">init-debug-imem</code> function in <code class="language-plaintext highlighter-rouge">array/imem.rkt</code>, run <code class="language-plaintext highlighter-rouge">racket src/spec.rkt</code>, and check the output.</p> </blockquote> <h3 id="part-3b-find-the-backdoor-instruction-40"> <a href="#part-3b-find-the-backdoor-instruction-40" class="anchor-heading" aria-labelledby="part-3b-find-the-backdoor-instruction-40"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Part 3B: Find the Backdoor Instruction (40%) </h3> <p>Only adding the exception is unlikely to be enough to find the backdoor instruction because our specification has not matched the implementation yet – it only supports 5 out of 10 instructions. But this might still be a good time to just go and try the verification, and to see what we can find. Try to run the verification with <code class="language-plaintext highlighter-rouge">racket src/veri.rkt</code>. What have you observed? You probably will see the same adder bug!</p> <p><strong>Assume the Adder Bug is not Triggered</strong></p> <p>It actually can be annoying during the formal verification that even if the design has many bugs, the formal verification framework might only be able to find one of them. This happens because as long as a program uses the add instruction and triggers the bug, it will cause the assertion to be false. The SMT solver will just become lazy and stop exploring other possible violations of the assertions.</p> <p>One normal solution is just fixing the existing bugs – No one wants so many bugs lying in the code base. However, sometimes, it would also be nice to find multiple bugs and do the fix together. We could achieve so by adding an <code class="language-plaintext highlighter-rouge">(assume #f)</code> on the execution path triggering the bug.</p> <blockquote class="exercise-title"> <p>3-2 Exercise</p> <p>Go to the <code class="language-plaintext highlighter-rouge">step-spec!</code> function in <code class="language-plaintext highlighter-rouge">spec.rkt</code>. Add an <code class="language-plaintext highlighter-rouge">(assume #f)</code> to the path executing the ADD and ADDI instructions.</p> <p>Then run <code class="language-plaintext highlighter-rouge">racket src/veri.rkt</code> and you should see no counterexample found (with the minimal <code class="language-plaintext highlighter-rouge">param-simuCycle</code> that gave you the adder bug).</p> </blockquote> <p><strong>Find the Backdoor Instruction, Finally</strong></p> <p>Now is the final time to find the backdoor instruction.</p> <blockquote class="exercise-title"> <p>3-3 Exercise</p> <p>Increase the value of <code class="language-plaintext highlighter-rouge">param-simuCycle</code> in <code class="language-plaintext highlighter-rouge">param/veri.rkt</code> and redo the verification, until you can find a counterexample generated by the solver.</p> </blockquote> <p>If lucky enough, you might directly find the backdoor instruction even without changing the code. Then you could just skip the following Exercise 3-4. (Though we still hope you could try it a bit.)</p> <p>Otherwise, you will find one of the 10 legal instructions (listed <a href="#simplications-on-the-original-psp-processor">here</a>) will trigger the assertion false – it will trigger an exception on the specification (because we have not supported it yet) while executing normally on the implementation. In this case, you need to add the support of this legal instruction and try the verification again until you can find the backdoor instruction.</p> <blockquote class="exercise-title"> <p>3-4 Exercise</p> <p>In the specification, gradually add the support of the legal instructions that trigger the assertion false until you can find the backdoor instruction. If needed, you could change the <code class="language-plaintext highlighter-rouge">spec-archState</code> and <code class="language-plaintext highlighter-rouge">impl-archState</code> functions to include CSRs and the Privilege level and check whether they match.</p> </blockquote> <blockquote class="discussion-title"> <p>3-5 Discussion</p> <p>What is the backdoor instruction you found? Take a screenshot of the terminal output at the cycle when this backdoor instruction is committed and include it in the report.</p> </blockquote> <blockquote class="hint-title"> <p>Reproducibility</p> <p>Unless you support all 10 instructions, we might not be able to reproduce your result because the SMT solver might just decide to find a different counterexample when we run it. This is fine as long as you have the screenshot! However, we do encourage you to support more instructions.</p> </blockquote> <blockquote class="discussion-title"> <p>3-6 Discussion</p> <p>Based on your experience in lab6 and lab7, how would you compare the pros and cons of fuzzing and formal verification techniques?</p> </blockquote> <!-- {: .hint-title} > You could cheat with `assume` > > Given that you already know the bug comes from an invalid instruction, you might find it appealing to add `(assume #f)` at places that you know will not contribute to finding this specific bug. > It is fine to do this! > This could save some engineering effort (but without caution, you might meet some weird bugs). > > Just remember in real-world verification, because you do not know where the bug will come from, you have to implement every detail in the specification. --> <h3 class="no_toc" id="grading-2"> <a href="#grading-2" class="anchor-heading" aria-labelledby="grading-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Grading </h3> <p>For Exercise 3-1/2/3, please finish them by following the instructions. For Exercise 3-4 you will get a full grade as long as you show the correct backdoor instruction being found through the screenshot in Discussion 3-5.</p> <!-- ## Part 4: Change the Privilege Level with the Backdoor Instruction (Optional, 5% Bonus) Have not tested the solution work yet. --> <h2 class="no_toc" id="thats-all-folks"> <a href="#thats-all-folks" class="anchor-heading" aria-labelledby="thats-all-folks"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> That’s All, Folks! </h2> <p>That’s all we have for you this semester. Congrats on completing Secure Hardware Design!! We sincerely hope you enjoyed this class and found the labs to be worthwhile.</p> <p>If there’s anything we can do to improve the course for future students, please let us know! (Anonymous feedback <a href="https://forms.gle/rB2nH6JsSWgZruy37">here</a>.)</p> <p>Have a great summer!</p> <h2 class="no_toc" id="acknowledgements"> <a href="#acknowledgements" class="anchor-heading" aria-labelledby="acknowledgements"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Acknowledgements </h2> <p>Made by Yuheng Yang.</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>

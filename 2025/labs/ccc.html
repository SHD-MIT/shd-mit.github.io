<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/2025/assets/css/just-the-docs-default.css"> <script src="/2025/assets/js/vendor/lunr.min.js"></script> <script src="/2025/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>C Crash Course | 6.5950/6.5951</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="C Crash Course" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Secure Hardware Design" /> <meta property="og:description" content="Secure Hardware Design" /> <meta property="og:site_name" content="6.5950/6.5951" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="C Crash Course" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Secure Hardware Design","headline":"C Crash Course","url":"/2025/labs/ccc.html"}</script> <!-- End Jekyll SEO tag --> <!-- Cover up the page while CSS is loading to prevent flicker --> <div id="preload-cover"></div> <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" /> <style> #preload-cover { position:fixed; height:100%; width:100%; top:0; left:0; background:#fff; z-index:9999; } @media (prefers-color-scheme: dark) { #preload-cover { position:fixed; height:100%; width:100%; top:0; left:0; background:#222326; z-index:9999; } } </style> <script> window.addEventListener('load', function() { var cover = document.getElementById('preload-cover'); cover.style.display = 'none'; }); </script> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Feather. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/2025/" class="site-title lh-tight"> 6.5950/6.5951 </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/2025/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/2025/calendar.html" class="nav-list-link">Calendar</a></li><li class="nav-list-item"><a href="/2025/lectureReadings.html" class="nav-list-link">Lecture Readings</a></li><li class="nav-list-item"><a href="/2025/paperDiscussion.html" class="nav-list-link">Paper Discussion</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Recitations category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/2025/recitations.html" class="nav-list-link">Recitations</a><ul class="nav-list "><li class="nav-list-item "><a href="/2025/recitations/cpp.html" class="nav-list-link">CTF of C Programming</a></li><li class="nav-list-item "><a href="/2025/recitations/cache.html" class="nav-list-link">Cache Recitation</a></li><li class="nav-list-item "><a href="/2025/recitations/physical.html" class="nav-list-link">CTF of Physical Attacks</a></li><li class="nav-list-item "><a href="/2025/recitations/riscv.html" class="nav-list-link">Binary Exploitation and RISC-V Warmup</a></li><li class="nav-list-item "><a href="/2025/recitations/formal.html" class="nav-list-link">Formal Verification</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Labs category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/2025/labs.html" class="nav-list-link">Labs</a><ul class="nav-list "><li class="nav-list-item active"><a href="/2025/labs/ccc.html" class="nav-list-link active">C Crash Course</a></li><li class="nav-list-item "><a href="/2025/labs/fingerprinting.html" class="nav-list-link">Website Fingerprinting</a></li><li class="nav-list-item "><a href="/2025/labs/cache.html" class="nav-list-link">Cache Attacks</a></li><li class="nav-list-item "><a href="/2025/labs/spectre.html" class="nav-list-link">Spectre Attacks</a></li><li class="nav-list-item "><a href="/2025/labs/rowhammer.html" class="nav-list-link">Rowhammer</a></li><li class="nav-list-item "><a href="/2025/labs/aslr.html" class="nav-list-link">ASLR Bypasses</a></li><li class="nav-list-item "><a href="/2025/labs/psp.html" class="nav-list-link">Pretty Secure Processor</a></li><li class="nav-list-item "><a href="/2025/labs/fuzz.html" class="nav-list-link">CPU Fuzzing</a></li><li class="nav-list-item "><a href="/2025/labs/formal.html" class="nav-list-link">CPU Verification</a></li></ul></li><li class="nav-list-item"><a href="/2025/paperReadingGuidance.html" class="nav-list-link">Paper Readings Guidance</a></li><li class="nav-list-item"><a href="/2025/forInstructors.html" class="nav-list-link">For Instructors</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search 6.5950/6.5951" aria-label="Search 6.5950/6.5951" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <span id="dark-light-switch" class="material-symbols-outlined"></span> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/2025/labs.html">Labs</a></li> <li class="breadcrumb-nav-list-item"><span>C Crash Course</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 class="no_toc" id="c-crash-course-lab"> <a href="#c-crash-course-lab" class="anchor-heading" aria-labelledby="c-crash-course-lab"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> C Crash Course Lab </h1> <p><strong>Due Date: Feb 11</strong>; Last Updated Date: Feb 1</p> <h2 class="no_toc" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of Contents </h2> <ul id="markdown-toc"> <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a> <ul> <li><a href="#setup" id="markdown-toc-setup">Setup</a></li> </ul> </li> <li><a href="#common-types-of-bugs" id="markdown-toc-common-types-of-bugs">Common types of Bugs</a> <ul> <li><a href="#memory-safety-bugs" id="markdown-toc-memory-safety-bugs">Memory Safety Bugs</a> <ul> <li><a href="#spatial-memory-safety-bugs" id="markdown-toc-spatial-memory-safety-bugs">Spatial Memory Safety Bugs</a></li> <li><a href="#temporal-memory-safety-bugs" id="markdown-toc-temporal-memory-safety-bugs">Temporal Memory Safety Bugs</a></li> <li><a href="#memory-leaks" id="markdown-toc-memory-leaks">Memory Leaks</a></li> <li><a href="#uninitialized-types" id="markdown-toc-uninitialized-types">Uninitialized Types</a></li> <li><a href="#errorneous-return-values" id="markdown-toc-errorneous-return-values">Errorneous Return Values</a></li> <li><a href="#integer-overflows" id="markdown-toc-integer-overflows">Integer Overflows</a></li> <li><a href="#undefined-behavior" id="markdown-toc-undefined-behavior">Undefined Behavior</a></li> <li><a href="#race-conditions" id="markdown-toc-race-conditions">Race Conditions</a></li> </ul> </li> </ul> </li> <li><a href="#debugging-tips" id="markdown-toc-debugging-tips">Debugging Tips:</a> <ul> <li><a href="#print-debugging" id="markdown-toc-print-debugging">Print Debugging</a></li> <li><a href="#sanitizer-debugging" id="markdown-toc-sanitizer-debugging">Sanitizer Debugging</a></li> <li><a href="#using-an-actual-debugger" id="markdown-toc-using-an-actual-debugger">Using an Actual Debugger</a></li> </ul> </li> <li><a href="#the-lab" id="markdown-toc-the-lab">The Lab</a> <ul> <li><a href="#the-basics" id="markdown-toc-the-basics">The Basics</a></li> <li><a href="#example-bug" id="markdown-toc-example-bug">Example Bug</a></li> <li><a href="#some-hints" id="markdown-toc-some-hints">Some hints</a></li> <li><a href="#additional-tester-features" id="markdown-toc-additional-tester-features">Additional Tester Features</a></li> <li><a href="#grading" id="markdown-toc-grading">Grading</a></li> <li><a href="#submission" id="markdown-toc-submission">Submission</a></li> </ul> </li> <li><a href="#acknolwedgements" id="markdown-toc-acknolwedgements">Acknolwedgements</a></li> </ul> <h2 class="no_toc" id="lab-details"> <a href="#lab-details" class="anchor-heading" aria-labelledby="lab-details"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Lab Details </h2> <h3 class="no_toc" id="collaboration-policy"> <a href="#collaboration-policy" class="anchor-heading" aria-labelledby="collaboration-policy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Collaboration Policy </h3> <p>Our full Academic Honesty policy can be found on the <a href="../index.html#collaboration-policy">Course Information page</a> of our website. As a reminder, all 6.5950/6.5951 labs should be completed individually. You may discuss the lab at a high level with a classmate, but you may not work on code together or share any of your code.</p> <h3 class="no_toc" id="getting-started"> <a href="#getting-started" class="anchor-heading" aria-labelledby="getting-started"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Getting Started </h3> <p>This lab is done on the Unicorn server - you will receive an email with login instructions. This can also be solved locally through the provided Dockerfile.</p> <p>We are using <code class="language-plaintext highlighter-rouge">git</code> for all the labs – instructions for setting up the git repository can be found on the <a href="../labs.html#github">labs page</a>.</p> <p>In addition to submitting code, you are required to submit a PDF lab report containing your answers to Discussion Questions to <a href="https://www.gradescope.com/courses/965204">Gradescope</a>.</p> <h2 id="introduction"> <a href="#introduction" class="anchor-heading" aria-labelledby="introduction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction </h2> <p>For the labs in this class, you will have to write a lot of C. This includes plenty of debugging too! Every year, we encounter many students who come to office hours due to a lack of understanding of basic C, so we decided to make this lab as a crash course.</p> <p>In this lab, you will help fix the bugs of a basic note taking library. We will run it through a series of test cases to catch for bugs and functionality problems. While we don’t expect the lab to be trivial for most people, if you find yourself struggling significantly to get through this lab, you should consider if this course is fit for you. And please do not use LLMs to analyze <code class="language-plaintext highlighter-rouge">shd-lib.c</code> - later labs won’t be solveable through them. LLMs are perfectly fine though if you are rusty on C and need a crash course.</p> <h3 id="setup"> <a href="#setup" class="anchor-heading" aria-labelledby="setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setup </h3> <p>Please do the lab on the provided machines once available. This is important, because I have setup the tests to layout the process heap in a specific way to maximize the chances of catching specific bugs (and we will grade in this same environment)! For those who start before the machines are provisioned, feel free to use the provided <code class="language-plaintext highlighter-rouge">docker-run.sh</code> script and <code class="language-plaintext highlighter-rouge">Dockerfile</code>. You can also solve this lab locally (especially if you are on Ubuntu 22.04), but <strong>please do a final check on the provided machines</strong>!</p> <p>First, clone the lab from git.</p> <p>You can now modify <code class="language-plaintext highlighter-rouge">shd-lib.c</code> (and only this, we will ignore all other diffs during submission) and then run the tester binary. Note that your modifications only rebuild the library, which the tester uses. We do not provide the source for the tester or any debugging symbols on purpose - feel free to reverse engineer it, but it’s much pretty trivial to deduce the test cases from the library anyways. If you can reconstruct the tester binary to a reasonable degree and demonstrate so through a report with readable pseudo-C, we’ll give you full credit for this lab automatically.</p> <p>Use <code class="language-plaintext highlighter-rouge">make libshd-lib.so</code> to rebuild the library, and then <code class="language-plaintext highlighter-rouge">make run</code> to run the tester (or <code class="language-plaintext highlighter-rouge">./tester</code>). You can also run it with <code class="language-plaintext highlighter-rouge">SANITIZED=1 make libshd-lib.so</code> to build with ASAN and UBSAN (we will elaborate on this later on). You will need to use <code class="language-plaintext highlighter-rouge">make sanitized-run</code> for this version (or <code class="language-plaintext highlighter-rouge">./sanitized_tester</code>), which has specifies the correct libraries to use for sanitizers.</p> <blockquote class="warning"> <p>The default Makefile rule runs the checks, which builds a sanitized version of <code class="language-plaintext highlighter-rouge">libshd-lib.so</code>. This means the library will only work with <code class="language-plaintext highlighter-rouge">sanizited_tester</code> and not <code class="language-plaintext highlighter-rouge">tester</code>. Run <code class="language-plaintext highlighter-rouge">make libshd-lib.so</code> to get a version that works with <code class="language-plaintext highlighter-rouge">tester</code>.</p> </blockquote> <p>Finally, <code class="language-plaintext highlighter-rouge">make check</code> is what we will use for grading. There are many bugs that trigger silently (ie. no visible corruption), and we will use <a href="https://valgrind.org/">Valgrind</a> to catch a subset of those.</p> <p>Feel free to write your own tester binary as well and link it to <code class="language-plaintext highlighter-rouge">libshd-lib.so</code>. You can add a Makefile rule and call <code class="language-plaintext highlighter-rouge">make &lt;rule_name&gt;</code>. This can be good practice for writing more C! For example:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LDFLAGS = -L. -lshd-lib -Wl,-rpath=.

tester: custom.c libshd-lib.so
    $(CC) $(CFLAGS) custom.c -o tester $(LDFLAGS)
</code></pre></div></div> <p>LLMs are really good for writing Makefiles too if you want to do some other setup.</p> <p>Lastly, some tips for using Makefiles. The filenames appearing after a rule name are the dependencies - <code class="language-plaintext highlighter-rouge">make</code> re-runs a rule if the file which correlates to a rule name has an earlier modification timestamp than its dependent filenames. <code class="language-plaintext highlighter-rouge">make clean</code> has been setup to clean the local build directories, <code class="language-plaintext highlighter-rouge">make -B</code> will force a re-make of everything regardless of modification timestamps, and <code class="language-plaintext highlighter-rouge">make -j&lt;num&gt;</code> will parallelize the build process with <code class="language-plaintext highlighter-rouge">num</code> cores (you shouldn’t need this at all for this lab).</p> <h2 id="common-types-of-bugs"> <a href="#common-types-of-bugs" class="anchor-heading" aria-labelledby="common-types-of-bugs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Common types of Bugs </h2> <p>C is very prone to bugs. Despite the many existing solutions, C is still the lingua franca of low-level systems programming, and gives you the most precise control over generated machine code. In this lab, you should encounter most of these bugs unless otherwise stated:</p> <h3 id="memory-safety-bugs"> <a href="#memory-safety-bugs" class="anchor-heading" aria-labelledby="memory-safety-bugs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Memory Safety Bugs </h3> <h4 id="spatial-memory-safety-bugs"> <a href="#spatial-memory-safety-bugs" class="anchor-heading" aria-labelledby="spatial-memory-safety-bugs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Spatial Memory Safety Bugs </h4> <p>Unlike most modern languages, C has no runtime bounds checking for array/buffer access. Combined with unchecked pointer arithmetic, one can really reference any offset from an object and potentially achieve arbitrary read or write. These issues are known as spatial memory violations. They can corrupt adjacent objects, stack return addresses, and other elements necessary for correct program execution. Some common bugs that fall under this category are known as OOB (out-of-bound) accesses and buffer overflows. While many of these seem trivial to fix, beware of string related operations. C represents strings as a null-terminated char array, and that final null byte can lead to a lot of off-by-one errors.</p> <h4 id="temporal-memory-safety-bugs"> <a href="#temporal-memory-safety-bugs" class="anchor-heading" aria-labelledby="temporal-memory-safety-bugs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Temporal Memory Safety Bugs </h4> <p>Unlike garbage-collected languages, memory is manually managed in C. Unlike smarter manual memory management languages like Rust or Ada (and really modern C++ too if you know how to use it correctly), C provides no compile time guarantees to act as guard rails for memory management. Temporal violations often involve de-referencing freed memory, which are known as use-after-frees. This can then lead to corruption within the allocator state or objects that are re-allocated in the same region (this is known as a type confusion bug). Double frees, in which memory is freed twice, will also trigger similar issues. This may seem like a silly issue for one to program, but will happen quite easily as code complexity increases.</p> <h4 id="memory-leaks"> <a href="#memory-leaks" class="anchor-heading" aria-labelledby="memory-leaks"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Memory Leaks </h4> <p>This closely relates to temporal memory safety bugs. Without a garbage collector, there is no runtime object liveness analysis. If you forget to manually free memory, your program will continue to grow in memory size. While perfectly fine for short-lived programs (and probably the correct thing to do for performance), this becomes a major problem for larger programs. Leak enough memory on Linux and you will trigger the OOM-killer, which starts going down your OS’s process list and terminating processes to free up memory. Our usage of Valgrind will specifically catch for this type of bug.</p> <h4 id="uninitialized-types"> <a href="#uninitialized-types" class="anchor-heading" aria-labelledby="uninitialized-types"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Uninitialized Types </h4> <p>There is no default initialization value in C. If you don’t explicitly initialize a variable, its contents will be undefined (usually, the contents come from a previous value at that same location). This can lead to a source of bugs! An extremely common case last year was students not initializing a data array, and ending up confused of how the sum of 0 data points for a certain index resulted in a random large number.</p> <h4 id="errorneous-return-values"> <a href="#errorneous-return-values" class="anchor-heading" aria-labelledby="errorneous-return-values"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Errorneous Return Values </h4> <p>C doesn’t really have a built-in exception system nor does it have the concept of a result/option monad like in Rust or Haskell for error checking. The type system thus causes an errorneous return value to share the same type as a successful return value (C has unions, but those unions have no enforced safety guarantees). A common case for this is in syscall relevant functions such as <code class="language-plaintext highlighter-rouge">read</code> - on success, it tells you the number of bytes that are read, but on failure, it returns a specific negative value. Another example more relevant to this lab are functions that return heap-allocated objects. On success, they will return a valid pointer, but on failure, it will return a null pointer. Technically, the address 0x0 can still be a valid address depending on system configuration, which makes null pointers especially problematic in certain scenarios… Tony Hoare calls this his billion dollar mistake.</p> <h4 id="integer-overflows"> <a href="#integer-overflows" class="anchor-heading" aria-labelledby="integer-overflows"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Integer Overflows </h4> <p>If you are familiar with a real programming language, then you already know this. If you come from Python, then pay attention. Integer primitives in real languages are backed by hardware registers, which are limited in size. Eventually, a register will overflow (Ex. adding 1 to 2^63-1 will overflow and bring the value back to 0). You should expect the natural number wrapping behavior for unsigned integers in C, but this overflow becomes undefined behavior for signed integers, which leads to our next point. There are also many other integer related quirks - take this <a href="https://www.acepace.net/integerQuiz/">quiz</a> to see how much you know!</p> <h4 id="undefined-behavior"> <a href="#undefined-behavior" class="anchor-heading" aria-labelledby="undefined-behavior"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Undefined Behavior </h4> <p>This is a very large class of bugs. C lists many different things as undefined behaviors, which basically means the compiler can do whatever it wants, including wiping your whole hard drive, and make any assumptions it wants (usually for the purpose of code optimization). This can lead to very very surprising behavior! Technically many of the previously discussed bugs fall in the category of “undefined behavior.”</p> <h4 id="race-conditions"> <a href="#race-conditions" class="anchor-heading" aria-labelledby="race-conditions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Race Conditions </h4> <p>You won’t encounter this in our lab. But this is a problem that plagues every language whenever concurrency and parallelism enters the picture. A subclass of this includes data races, which some strongly typed languages like Rust has solved.</p> <h2 id="debugging-tips"> <a href="#debugging-tips" class="anchor-heading" aria-labelledby="debugging-tips"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Debugging Tips: </h2> <p>There are a few ways to debug in C.</p> <h3 id="print-debugging"> <a href="#print-debugging" class="anchor-heading" aria-labelledby="print-debugging"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Print Debugging </h3> <p>The best way in my opinion is print debugging. Use printf to add print statements wherever you need them. You can easily deduce all the test cases as well with this technique. Note that our tester binary includes the following initial call:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">setbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div> <p>Standard library level IO functions often buffer input - you might miss a print statement if you don’t end the text with a newline as the default is line-buffering (and will also affect the heap layout). These <code class="language-plaintext highlighter-rouge">setbuf</code> calls disable bufferring.</p> <p>C print functions rely on format specifiers, and you can learn all about them <a href="https://man7.org/linux/man-pages/man3/fprintf.3.html">https://man7.org/linux/man-pages/man3/fprintf.3.html</a>. Generally, you only need <code class="language-plaintext highlighter-rouge">%d</code> for <code class="language-plaintext highlighter-rouge">uint32_t</code> (I highly recommend that everyone use the bitwidth typed integers in C from <code class="language-plaintext highlighter-rouge">stdint.h</code> instead of the default integer types in C), <code class="language-plaintext highlighter-rouge">%lld</code> for <code class="language-plaintext highlighter-rouge">uint64_t</code>, <code class="language-plaintext highlighter-rouge">%x</code> for <code class="language-plaintext highlighter-rouge">uint32_t</code> in unsigned hex, <code class="language-plaintext highlighter-rouge">%llx</code> for <code class="language-plaintext highlighter-rouge">uint64_t</code> in unsigned hex, <code class="language-plaintext highlighter-rouge">%p</code> for pointers, <code class="language-plaintext highlighter-rouge">%c</code> for chars, and <code class="language-plaintext highlighter-rouge">%s</code> for strings.</p> <p>For example, if <code class="language-plaintext highlighter-rouge">foo</code> is a pointer to some struct, <code class="language-plaintext highlighter-rouge">bar</code> is an <code class="language-plaintext highlighter-rouge">uint32_t</code>, and <code class="language-plaintext highlighter-rouge">foobar</code> is a string, you would do this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>printf("foo: %p bar: %x foobar: %s", foo, bar, foobar);
</code></pre></div></div> <p>Do not ever directly print a non-compile time constant string as the first argument in printf ever in C code. Doing so will get your codebase compromised thanks to a specifier known as <code class="language-plaintext highlighter-rouge">%n</code> that allows for arbitrary write into memory.</p> <h3 id="sanitizer-debugging"> <a href="#sanitizer-debugging" class="anchor-heading" aria-labelledby="sanitizer-debugging"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Sanitizer Debugging </h3> <p>Recall ASAN and UBSAN from earlier. These are helpful tools that instrument your code to help catch most memory safety and undefined behavior bugs during runtime. You run the instrumented version and whenever a violation is detected, you receive a report with a backtrace. For example, the starter code will trigger the following backtrace one of the first test cases.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./sanitized_tester
------------------------------------------------------------
Running BUG_CHECK_0 Test, notebook length: 10
------------------------------------------------------------
read_page
AddressSanitizer:DEADLYSIGNAL
=================================================================
==357005==ERROR: AddressSanitizer: SEGV on unknown address 0x607000013980 (pc 0x7f7d7371584e bp 0x7ffd21a66fc0 sp 0x7ffd21a66fa0 T0)
==357005==The signal is caused by a READ memory access.
    #0 0x7f7d7371584e in read_page /shd-lib.c:25
    #1 0x5e37b6534bd9  (/sanitized_tester+0xaabd9)
    #2 0x5e37b6554c54  (/sanitized_tester+0xcac54)
    #3 0x5e37b6529301  (/sanitized_tester+0x9f301)
    #4 0x5e37b65133b7  (/sanitized_tester+0x893b7)
    #5 0x7f7d71c29d8f in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #6 0x7f7d71c29e3f in __libc_start_main_impl ../csu/libc-start.c:392
    #7 0x5e37b6513944  (/sanitized_tester+0x89944)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV /shd-lib.c:25 in read_page
==357005==ABORTING

</code></pre></div></div> <p>You can catch a lot of bugs just with this technique.</p> <h3 id="using-an-actual-debugger"> <a href="#using-an-actual-debugger" class="anchor-heading" aria-labelledby="using-an-actual-debugger"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using an Actual Debugger </h3> <p>This should be your last resort, but can be useful for pinpointing some hard to catch bugs. The debugger I recommend is GDB with <a href="https://github.com/hugsy/gef">GEF</a> extensions. Vanilla GDB looks ugly, isn’t fun to use, and defaults to AT&amp;T assembly syntax. There are many GDB guides out there, but these are what I find useful (though GEF already automatically shows a lot of the information these commands can reveal).</p> <ul> <li><code class="language-plaintext highlighter-rouge">bt</code>: for dumping a stack backtrace</li> <li><code class="language-plaintext highlighter-rouge">p $&lt;var&gt;</code>: display the value of a variable (which can just be a register name or an address). You can also typecase the var in C syntax to get a pretty-print, but that is dependent on whether there is sufficient DWARF debug information.</li> <li><code class="language-plaintext highlighter-rouge">disas &lt;address&gt;</code>: disassembles the current function, or starting from an address if specified.</li> <li><code class="language-plaintext highlighter-rouge">x/&lt;NUM&gt;&lt;specifier&gt;x &lt;address&gt;</code>: Shows <code class="language-plaintext highlighter-rouge">NUM</code> <code class="language-plaintext highlighter-rouge">specifier</code> sized elements in hex starting from <code class="language-plaintext highlighter-rouge">address</code>. Specifiers include <code class="language-plaintext highlighter-rouge">g</code> for giant word (8 bytes), <code class="language-plaintext highlighter-rouge">w</code> for word (4 bytes), <code class="language-plaintext highlighter-rouge">h</code> for half-word (2 bytes), or <code class="language-plaintext highlighter-rouge">b</code> for byte. If you replace the x after the specifier with an <code class="language-plaintext highlighter-rouge">i</code>, you can get a disassembly dump as well.</li> <li><code class="language-plaintext highlighter-rouge">b sym</code>/<code class="language-plaintext highlighter-rouge">b address</code>: set a breakpoint at an address. You can also specify a conditional expression for <a href="https://ftp.gnu.org/old-gnu/Manuals/gdb/html_node/gdb_33.html">conditional breakpoints</a>.</li> <li><code class="language-plaintext highlighter-rouge">watch</code>: <a href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/Set-Watchpoints.html">watchpoints</a> are like breakpoints, but for value changes in the program. I really doubt you’ll ever need it in this class, but a useful tool to have</li> <li><code class="language-plaintext highlighter-rouge">c</code>: continue program execution</li> <li><code class="language-plaintext highlighter-rouge">r</code>: start program execution</li> <li><code class="language-plaintext highlighter-rouge">s</code>/<code class="language-plaintext highlighter-rouge">n</code>: step and next. Step goes to the next source line, entering function calls, while next goes to the next source line, skipping function calls. There are many different variations of this, so take a look <a href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/Continuing-and-Stepping.html">here</a>. One variation worth mentioning are the <code class="language-plaintext highlighter-rouge">stepi</code> and <code class="language-plaintext highlighter-rouge">nexti</code> variants, which operate at the instruction granularity.</li> <li><code class="language-plaintext highlighter-rouge">search-pattern</code>: a GEF specific extension that is a life-saver. This allows you to search for arbitrary memory patterns at arbitrary address ranges.</li> </ul> <h2 id="the-lab"> <a href="#the-lab" class="anchor-heading" aria-labelledby="the-lab"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Lab </h2> <p>The goal of this lab is to fix the bugs - passing the tester checks should satisfy most of that.</p> <h3 id="the-basics"> <a href="#the-basics" class="anchor-heading" aria-labelledby="the-basics"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Basics </h3> <p>Refer very carefully to the comments in <code class="language-plaintext highlighter-rouge">shd-lib.h</code> for the spec. One thing to realize about the struct definitions is the array declaration in <code class="language-plaintext highlighter-rouge">page_t</code>:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">content</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">page_t</span><span class="p">;</span>
</code></pre></div></div> <p>Usually, variable length arrays are not allowed in structs, except when it is the last field. This is a very common pattern in networking or IPC code. You can allocate these types of elastic structs with the following pattern: <code class="language-plaintext highlighter-rouge">malloc(sizeof(elastic_type) + additional_size)</code>.</p> <p>In general, this library provides notebook objects with a fixed amount of pages, which users can read, write, erase, grow, and append to.</p> <h3 id="example-bug"> <a href="#example-bug" class="anchor-heading" aria-labelledby="example-bug"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example Bug </h3> <p>One really simple bug that you should catch immediately is the lack of bounds checking in all the notebook relevant operations. Users have to specify a <code class="language-plaintext highlighter-rouge">page_nr</code> for most of them, yet there are no checks to see whether the <code class="language-plaintext highlighter-rouge">page_nr</code> is even possible for this notebook’s <code class="language-plaintext highlighter-rouge">pages</code> array.</p> <h3 id="some-hints"> <a href="#some-hints" class="anchor-heading" aria-labelledby="some-hints"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Some hints </h3> <ul> <li>As mentioned earlier, the null byte in C strings can be really finnicky, especially when performing operations on them.</li> <li>The first 6 bugs we discussed earlier all appear here (and technically the 7th, because all those bugs lead to undefined behavior)</li> <li>I talked about reading the spec for <code class="language-plaintext highlighter-rouge">shd-lib.h</code> earlier, but what about <code class="language-plaintext highlighter-rouge">malloc</code>, <code class="language-plaintext highlighter-rouge">free</code>, and <code class="language-plaintext highlighter-rouge">realloc</code></li> <li>Remember the base size of flexible structs.</li> <li>One really tricky bug comes directly from a real world bug. Look into the root cause of CVE-2022-0185 for the Linux kernel. Don’t worry, all you need is basic C knowledge and it’s a one line fix!</li> </ul> <h3 id="additional-tester-features"> <a href="#additional-tester-features" class="anchor-heading" aria-labelledby="additional-tester-features"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Additional Tester Features </h3> <p>Since certain bugs more easily manifest themselves from a simpler heap state in these short test cases (before many deallocations occur), you can manually run the <code class="language-plaintext highlighter-rouge">./tester</code> binary with a list of names of certain BUG_CHECKS to run through. For example: <code class="language-plaintext highlighter-rouge">./tester BUG_CHECK_3 BUG_CHECK_6 BUG_CHECK_9</code>.</p> <blockquote class="exercise-title"> <p>1-1 Exercise</p> <p>Fix all the bugs in shd-lib.c so that the test cases can pass!</p> </blockquote> <blockquote class="discussion-title"> <p>1-2 Discussion Question</p> <p>Write about 5 bugs that you found in this lab. A single sentence for each will suffice.</p> </blockquote> <h3 id="grading"> <a href="#grading" class="anchor-heading" aria-labelledby="grading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Grading </h3> <p>The programming component makes up 90% of the points in this lab. Each test case is worth the same (with the final <code class="language-plaintext highlighter-rouge">valgrind</code> test being considered a single test case). Our grader does <strong>NOT</strong> take into consideration of a passing test case that comes after a crashing test case.</p> <p>The discussion makes up 10% of the points in this lab.</p> <h3 id="submission"> <a href="#submission" class="anchor-heading" aria-labelledby="submission"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Submission </h3> <p>Push your code to the Github classroom, and submit your discussion responses to Gradescope.</p> <h2 id="acknolwedgements"> <a href="#acknolwedgements" class="anchor-heading" aria-labelledby="acknolwedgements"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Acknolwedgements </h2> <p>Contributors: William Liu, Shixin Song, Mengjia Yan</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
